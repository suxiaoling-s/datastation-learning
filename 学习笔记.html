<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Station Web API æŠ€æœ¯æ ˆå­¦ä¹ ç¬”è®°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
            scroll-margin-top: 20px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            scroll-margin-top: 20px;
        }
        
        h3 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 15px;
            scroll-margin-top: 20px;
        }
        
        h4, h5, h6 {
            color: #666;
            margin-top: 20px;
            margin-bottom: 10px;
            scroll-margin-top: 20px;
        }
        
        p {
            margin-bottom: 15px;
        }
        
        ul, ol {
            margin-left: 30px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "Courier New", monospace;
            font-size: 0.9em;
        }
        
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 20px 0;
        }
        
        pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
        
        blockquote {
            border-left: 4px solid #3498db;
            padding-left: 20px;
            margin: 20px 0;
            color: #666;
            font-style: italic;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        a {
            color: #3498db;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        a:hover {
            color: #2980b9;
            text-decoration: underline;
        }
        
        a:visited {
            color: #8e44ad;
        }
        
        hr {
            border: none;
            border-top: 2px solid #ecf0f1;
            margin: 40px 0;
        }
        
        .toc {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 40px;
            border-left: 4px solid #3498db;
        }
        
        .toc h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: none;
        }
        
        .toc ul {
            list-style-type: none;
            margin-left: 0;
        }
        
        .toc li {
            margin-bottom: 8px;
            line-height: 1.8;
        }
        
        .toc a {
            color: #2c3e50;
            font-weight: 500;
        }
        
        .toc a:hover {
            color: #3498db;
            text-decoration: underline;
        }
        
        .toc ul ul {
            margin-left: 20px;
            margin-top: 5px;
        }
        
        .toc ul ul ul {
            margin-left: 20px;
        }
        
        /* æ ‡é¢˜é”šç‚¹æ ·å¼ */
        h1[id], h2[id], h3[id], h4[id], h5[id], h6[id] {
            position: relative;
        }
        
        h1[id]:hover::before, h2[id]:hover::before, h3[id]:hover::before,
        h4[id]:hover::before, h5[id]:hover::before, h6[id]:hover::before {
            content: "ğŸ”—";
            position: absolute;
            left: -30px;
            font-size: 0.8em;
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            body {
                padding: 10px;
            }
            
            .toc {
                padding: 15px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        hljs.highlightAll();
        
        // å¹³æ»‘æ»šåŠ¨å¢å¼º
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸ºæ‰€æœ‰é”šç‚¹é“¾æ¥æ·»åŠ å¹³æ»‘æ»šåŠ¨
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    const href = this.getAttribute('href');
                    if (href !== '#' && href.length > 1) {
                        const target = document.querySelector(href);
                        if (target) {
                            e.preventDefault();
                            const offset = 80; // åç§»é‡ï¼Œé¿å…è¢«å›ºå®šå¯¼èˆªæ é®æŒ¡
                            const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - offset;
                            window.scrollTo({
                                top: targetPosition,
                                behavior: 'smooth'
                            });
                        }
                    }
                });
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <h1 id="data-station-web-api">Data Station Web API æŠ€æœ¯æ ˆå­¦ä¹ ç¬”è®°</h1>
<blockquote>
<p>åŸºäº FastAPI + Celery + Redis + PostgreSQL çš„ç°ä»£åŒ– Web API æ¡†æ¶å®Œæ•´æŠ€æœ¯è§£æ</p>
</blockquote>
<hr />
<h2 id="bookscjk-unified-ideograph-76eecjk-unified-ideograph-5f55">ğŸ“š ç›®å½•</h2>
<ol>
<li><a href="#cjk-unified-ideograph-9879cjk-unified-ideograph-76eecjk-unified-ideograph-6982cjk-unified-ideograph-8ff0">é¡¹ç›®æ¦‚è¿°</a></li>
<li><a href="#fastapi">FastAPI æ¡†æ¶</a></li>
<li><a href="#sqlalchemy-orm">SQLAlchemy ORM ä¸æ•°æ®åº“è®¾è®¡</a></li>
<li><a href="#redis">Redis ç¼“å­˜ä¸è¿æ¥æ± ç®¡ç†</a></li>
<li><a href="#celery">Celery å¼‚æ­¥ä»»åŠ¡å¤„ç†</a></li>
<li><a href="#jwt">JWT è®¤è¯ä¸å®‰å…¨æœºåˆ¶</a></li>
<li><a href="#cjk-unified-ideograph-9879cjk-unified-ideograph-76eecjk-unified-ideograph-67b6cjk-unified-ideograph-6784cjk-unified-ideograph-8bbecjk-unified-ideograph-8ba1cjk-unified-ideograph-6a21cjk-unified-ideograph-5f0f">é¡¹ç›®æ¶æ„è®¾è®¡æ¨¡å¼</a></li>
<li><a href="#cjk-unified-ideograph-4e91cjk-unified-ideograph-670dcjk-unified-ideograph-52a1cjk-unified-ideograph-96c6cjk-unified-ideograph-6210">äº‘æœåŠ¡é›†æˆ</a></li>
<li><a href="#cjk-unified-ideograph-6d4bcjk-unified-ideograph-8bd5cjk-unified-ideograph-4e0ecjk-unified-ideograph-90e8cjk-unified-ideograph-7f72">æµ‹è¯•ä¸éƒ¨ç½²</a></li>
<li><a href="#cjk-unified-ideograph-6700cjk-unified-ideograph-4f73cjk-unified-ideograph-5b9ecjk-unified-ideograph-8df5cjk-unified-ideograph-603bcjk-unified-ideograph-7ed3">æœ€ä½³å®è·µæ€»ç»“</a></li>
</ol>
<hr />
<h2 id="cjk-unified-ideograph-9879cjk-unified-ideograph-76eecjk-unified-ideograph-6982cjk-unified-ideograph-8ff0">é¡¹ç›®æ¦‚è¿°</h2>
<h3 id="cjk-unified-ideograph-6280cjk-unified-ideograph-672fcjk-unified-ideograph-6808cjk-unified-ideograph-603bcjk-unified-ideograph-89c8">æŠ€æœ¯æ ˆæ€»è§ˆ</h3>
<p>è¿™æ˜¯ä¸€ä¸ªåŸºäº <strong>FastAPI</strong> æ„å»ºçš„ç°ä»£åŒ– Web API æ¡†æ¶ï¼Œé‡‡ç”¨äº†å®Œæ•´çš„ä¼ä¸šçº§æŠ€æœ¯æ ˆï¼š</p>
<ul>
<li><strong>Web æ¡†æ¶</strong>: FastAPI (å¼‚æ­¥ã€é«˜æ€§èƒ½)</li>
<li><strong>æ•°æ®åº“</strong>: PostgreSQL + SQLAlchemy ORM</li>
<li><strong>æ•°æ®åº“è¿ç§»</strong>: Alembic</li>
<li><strong>ç¼“å­˜/æ¶ˆæ¯é˜Ÿåˆ—</strong>: Redis</li>
<li><strong>å¼‚æ­¥ä»»åŠ¡</strong>: Celery</li>
<li><strong>è®¤è¯æˆæƒ</strong>: JWT (JSON Web Tokens)</li>
<li><strong>å¯†ç åŠ å¯†</strong>: bcrypt</li>
<li><strong>æ•°æ®éªŒè¯</strong>: Pydantic</li>
<li><strong>æ—¥å¿—ç³»ç»Ÿ</strong>: loguru</li>
<li><strong>äº‘æœåŠ¡</strong>: é˜¿é‡Œäº‘(çŸ­ä¿¡ã€é‚®ä»¶) + è…¾è®¯äº‘(éªŒè¯ç )</li>
<li><strong>å®¹å™¨åŒ–</strong>: Docker</li>
<li><strong>æµ‹è¯•æ¡†æ¶</strong>: pytest</li>
</ul>
<h3 id="cjk-unified-ideograph-9879cjk-unified-ideograph-76eecjk-unified-ideograph-7ed3cjk-unified-ideograph-6784">é¡¹ç›®ç»“æ„</h3>
<div class="highlight"><pre><span></span><code>web-api/
â”œâ”€â”€ app/                    # ä¸»åº”ç”¨ä»£ç 
â”‚   â”œâ”€â”€ api/v1/endpoints/  # API ç«¯ç‚¹
â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒé…ç½®å’Œå·¥å…·
â”‚   â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/           # æ•°æ®éªŒè¯æ¨¡å¼
â”‚   â””â”€â”€ services/          # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ alembic/               # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ tests/                 # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ scripts/               # å·¥å…·è„šæœ¬
â”œâ”€â”€ main.py                # åº”ç”¨å…¥å£
â””â”€â”€ celery_worker.py       # Celery Worker å¯åŠ¨
</code></pre></div>

<hr />
<h2 id="1-fastapi">1. FastAPI æ¡†æ¶</h2>
<h3 id="11-fastapi">1.1 FastAPI æ ¸å¿ƒæ¦‚å¿µ</h3>
<p>FastAPI æ˜¯ä¸€ä¸ªç°ä»£ã€å¿«é€Ÿï¼ˆé«˜æ€§èƒ½ï¼‰çš„ Web æ¡†æ¶ï¼Œç”¨äºæ„å»ºåŸºäºæ ‡å‡† Python ç±»å‹æç¤ºçš„ APIã€‚</p>
<h4 id="cjk-unified-ideograph-5173cjk-unified-ideograph-952ecjk-unified-ideograph-7279cjk-unified-ideograph-6027">å…³é”®ç‰¹æ€§</h4>
<ul>
<li><strong>é«˜æ€§èƒ½</strong>: åŸºäº Starlette å’Œ Pydanticï¼Œæ€§èƒ½ä¸ NodeJS å’Œ Go ç›¸å½“</li>
<li><strong>æ˜“ç”¨æ€§</strong>: è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ï¼ˆSwagger/OpenAPIï¼‰</li>
<li><strong>ç±»å‹å®‰å…¨</strong>: åŸºäº Python 3.6+ çš„ç±»å‹æç¤º</li>
<li><strong>å¼‚æ­¥æ”¯æŒ</strong>: åŸç”Ÿæ”¯æŒ async/await</li>
</ul>
<h4 id="cjk-unified-ideograph-9879cjk-unified-ideograph-76eecjk-unified-ideograph-4e2dcjk-unified-ideograph-7684cjk-unified-ideograph-5e94cjk-unified-ideograph-7528">é¡¹ç›®ä¸­çš„åº”ç”¨</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># main.py - FastAPI åº”ç”¨åˆå§‹åŒ–</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>

<span class="c1"># CORS ä¸­é—´ä»¶é…ç½®</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">CORSMiddleware</span><span class="p">,</span>
    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># åŒ…å«è·¯ç”±</span>
<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">api_router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="12">1.2 è·¯ç”±ç³»ç»Ÿ</h3>
<p>FastAPI ä½¿ç”¨è£…é¥°å™¨å®šä¹‰è·¯ç”±ï¼Œæ”¯æŒå¼‚æ­¥å’ŒåŒæ­¥å¤„ç†å‡½æ•°ã€‚</p>
<h4 id="cjk-unified-ideograph-8defcjk-unified-ideograph-7531cjk-unified-ideograph-5b9acjk-unified-ideograph-4e49cjk-unified-ideograph-793acjk-unified-ideograph-4f8b">è·¯ç”±å®šä¹‰ç¤ºä¾‹</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># app/api/v1/endpoints/auth.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/register&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">register_user</span><span class="p">(</span>
    <span class="n">user_data</span><span class="p">:</span> <span class="n">UserRegister</span><span class="p">,</span>  <span class="c1"># Pydantic æ¨¡å‹è‡ªåŠ¨éªŒè¯</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">),</span>  <span class="c1"># ä¾èµ–æ³¨å…¥</span>
<span class="p">):</span>
    <span class="c1"># ä¸šåŠ¡é€»è¾‘</span>
    <span class="k">pass</span>
</code></pre></div>

<h4 id="cjk-unified-ideograph-4f9dcjk-unified-ideograph-8d56cjk-unified-ideograph-6ce8cjk-unified-ideograph-5165cjk-unified-ideograph-7cfbcjk-unified-ideograph-7edf">ä¾èµ–æ³¨å…¥ç³»ç»Ÿ</h4>
<p>FastAPI çš„ä¾èµ–æ³¨å…¥æ˜¯å…¶æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œç”¨äºï¼š<br />
- æ•°æ®åº“ä¼šè¯ç®¡ç†<br />
- ç”¨æˆ·è®¤è¯<br />
- æƒé™æ£€æŸ¥</p>
<div class="highlight"><pre><span></span><code><span class="c1"># æ•°æ®åº“ä¾èµ–</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_database</span><span class="p">():</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">SessionLocal</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">database</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># è®¤è¯ä¾èµ–</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
    <span class="n">credentials</span><span class="p">:</span> <span class="n">HTTPAuthorizationCredentials</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">security</span><span class="p">),</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span>
    <span class="n">token_data</span> <span class="o">=</span> <span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="c1"># ... éªŒè¯é€»è¾‘</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>

<h3 id="13">1.3 è¯·æ±‚/å“åº”æ¨¡å‹</h3>
<p>ä½¿ç”¨ Pydantic æ¨¡å‹å®šä¹‰è¯·æ±‚å’Œå“åº”çš„æ•°æ®ç»“æ„ï¼Œè‡ªåŠ¨è¿›è¡ŒéªŒè¯å’Œåºåˆ—åŒ–ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/schemas/user.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserRegister</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">phone_number</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">sms_code</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UserResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
        <span class="n">from_attributes</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># æ”¯æŒä» ORM æ¨¡å‹è½¬æ¢</span>
</code></pre></div>

<h3 id="14">1.4 å¼‚å¸¸å¤„ç†</h3>
<p>FastAPI ä½¿ç”¨æ ‡å‡†çš„ HTTPException å¤„ç†é”™è¯¯ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
        <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span>
    <span class="p">)</span>
</code></pre></div>

<h3 id="15-api">1.5 è‡ªåŠ¨ API æ–‡æ¡£</h3>
<p>FastAPI è‡ªåŠ¨ç”Ÿæˆäº¤äº’å¼ API æ–‡æ¡£ï¼š<br />
- Swagger UI: <code>http://localhost:8000/docs</code><br />
- ReDoc: <code>http://localhost:8000/redoc</code></p>
<h3 id="16">1.6 å­¦ä¹ è¦ç‚¹</h3>
<ol>
<li><strong>å¼‚æ­¥ç¼–ç¨‹</strong>: ä½¿ç”¨ <code>async def</code> å®šä¹‰å¼‚æ­¥ç«¯ç‚¹ï¼Œä½¿ç”¨ <code>await</code> è°ƒç”¨å¼‚æ­¥æ“ä½œ</li>
<li><strong>ç±»å‹æç¤º</strong>: å……åˆ†åˆ©ç”¨ç±»å‹æç¤ºï¼Œæé«˜ä»£ç å¯è¯»æ€§å’Œ IDE æ”¯æŒ</li>
<li><strong>ä¾èµ–æ³¨å…¥</strong>: åˆç†ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œå‡å°‘ä»£ç é‡å¤</li>
<li><strong>Pydantic æ¨¡å‹</strong>: ä½¿ç”¨ Pydantic è¿›è¡Œæ•°æ®éªŒè¯ï¼Œç¡®ä¿æ•°æ®å®‰å…¨</li>
</ol>
<hr />
<h2 id="2-sqlalchemy-orm">2. SQLAlchemy ORM ä¸æ•°æ®åº“è®¾è®¡</h2>
<h3 id="21-sqlalchemy">2.1 SQLAlchemy æ ¸å¿ƒæ¦‚å¿µ</h3>
<p>SQLAlchemy æ˜¯ Python æœ€æµè¡Œçš„ ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰æ¡†æ¶ï¼Œæä¾›äº† SQL å·¥å…·åŒ…å’Œ ORMã€‚</p>
<h4 id="cjk-unified-ideograph-9879cjk-unified-ideograph-76eecjk-unified-ideograph-4e2dcjk-unified-ideograph-7684cjk-unified-ideograph-6570cjk-unified-ideograph-636ecjk-unified-ideograph-5e93cjk-unified-ideograph-914dcjk-unified-ideograph-7f6e">é¡¹ç›®ä¸­çš„æ•°æ®åº“é…ç½®</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># app/core/database.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.declarative</span><span class="w"> </span><span class="kn">import</span> <span class="n">declarative_base</span>

<span class="c1"># åˆ›å»ºæ•°æ®åº“å¼•æ“</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">database_url</span><span class="p">,</span>
    <span class="n">pool_pre_ping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>      <span class="c1"># è¿æ¥å‰æ£€æŸ¥è¿æ¥æ˜¯å¦æœ‰æ•ˆ</span>
    <span class="n">pool_recycle</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>        <span class="c1"># è¿æ¥å›æ”¶æ—¶é—´ï¼ˆç§’ï¼‰</span>
<span class="p">)</span>

<span class="c1"># åˆ›å»ºä¼šè¯å·¥å‚</span>
<span class="n">SessionLocal</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autoflush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># åŸºç¡€æ¨¡å‹ç±»</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
</code></pre></div>

<h3 id="22">2.2 æ•°æ®æ¨¡å‹å®šä¹‰</h3>
<p>ä½¿ç”¨ SQLAlchemy çš„å£°æ˜å¼è¯­æ³•å®šä¹‰æ•°æ®æ¨¡å‹ã€‚</p>
<h4 id="cjk-unified-ideograph-7528cjk-unified-ideograph-6237cjk-unified-ideograph-6a21cjk-unified-ideograph-578bcjk-unified-ideograph-793acjk-unified-ideograph-4f8b">ç”¨æˆ·æ¨¡å‹ç¤ºä¾‹</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># app/models/user.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">DateTime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">36</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">is_active</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="c1"># å…³ç³»å®šä¹‰</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Task&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="cjk-unified-ideograph-5173cjk-unified-ideograph-952ecjk-unified-ideograph-6982cjk-unified-ideograph-5ff5">å…³é”®æ¦‚å¿µ</h4>
<ol>
<li><strong>è¡¨å®šä¹‰</strong>: <code>__tablename__</code> æŒ‡å®šæ•°æ®åº“è¡¨å</li>
<li><strong>åˆ—å®šä¹‰</strong>: ä½¿ç”¨ <code>Column</code> å®šä¹‰å­—æ®µï¼ŒæŒ‡å®šç±»å‹ã€çº¦æŸ</li>
<li><strong>ç´¢å¼•</strong>: ä½¿ç”¨ <code>index=True</code> åˆ›å»ºç´¢å¼•</li>
<li><strong>å…³ç³»</strong>: ä½¿ç”¨ <code>relationship</code> å®šä¹‰è¡¨é—´å…³ç³»</li>
<li><strong>æ—¶é—´æˆ³</strong>: ä½¿ç”¨ <code>server_default=func.now()</code> è®¾ç½®é»˜è®¤æ—¶é—´</li>
</ol>
<h3 id="23">2.3 æ•°æ®åº“ä¼šè¯ç®¡ç†</h3>
<p>ä½¿ç”¨ FastAPI çš„ä¾èµ–æ³¨å…¥ç®¡ç†æ•°æ®åº“ä¼šè¯ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è·å–æ•°æ®åº“ä¼šè¯ï¼ˆä¾èµ–æ³¨å…¥ï¼‰&quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">SessionLocal</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">database</span>  <span class="c1"># ç”Ÿæˆå™¨æ¨¡å¼ï¼Œç¡®ä¿å…³é—­è¿æ¥</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># åœ¨è·¯ç”±ä¸­ä½¿ç”¨</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/me&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user_info</span><span class="p">(</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">),</span>
<span class="p">):</span>
    <span class="c1"># ä½¿ç”¨ database è¿›è¡ŒæŸ¥è¯¢</span>
    <span class="k">pass</span>
</code></pre></div>

<h3 id="24-alembic">2.4 Alembic æ•°æ®åº“è¿ç§»</h3>
<p>Alembic æ˜¯ SQLAlchemy çš„æ•°æ®åº“è¿ç§»å·¥å…·ï¼Œç”¨äºç‰ˆæœ¬æ§åˆ¶æ•°æ®åº“ç»“æ„ã€‚</p>
<h4 id="cjk-unified-ideograph-8fc1cjk-unified-ideograph-79fbcjk-unified-ideograph-914dcjk-unified-ideograph-7f6e">è¿ç§»é…ç½®</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># alembic/env.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">Base</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models.task</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>

<span class="c1"># å¯¼å…¥æ‰€æœ‰æ¨¡å‹ï¼Œç”¨äºè‡ªåŠ¨ç”Ÿæˆè¿ç§»</span>
<span class="n">target_metadata</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span>
</code></pre></div>

<h4 id="cjk-unified-ideograph-5e38cjk-unified-ideograph-7528cjk-unified-ideograph-8fc1cjk-unified-ideograph-79fbcjk-unified-ideograph-547dcjk-unified-ideograph-4ee4">å¸¸ç”¨è¿ç§»å‘½ä»¤</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># åˆ›å»ºè¿ç§»è„šæœ¬</span>
alembic<span class="w"> </span>revision<span class="w"> </span>--autogenerate<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;æè¿°ä¿¡æ¯&quot;</span>

<span class="c1"># å‡çº§æ•°æ®åº“</span>
alembic<span class="w"> </span>upgrade<span class="w"> </span>head

<span class="c1"># é™çº§æ•°æ®åº“</span>
alembic<span class="w"> </span>downgrade<span class="w"> </span>-1

<span class="c1"># æŸ¥çœ‹å½“å‰ç‰ˆæœ¬</span>
alembic<span class="w"> </span>current

<span class="c1"># æŸ¥çœ‹å†å²</span>
alembic<span class="w"> </span><span class="nb">history</span>
</code></pre></div>

<h4 id="cjk-unified-ideograph-8fc1cjk-unified-ideograph-79fbcjk-unified-ideograph-6587cjk-unified-ideograph-4ef6cjk-unified-ideograph-793acjk-unified-ideograph-4f8b">è¿ç§»æ–‡ä»¶ç¤ºä¾‹</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># alembic/versions/xxxxx_initial_schema.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="s1">&#39;users&#39;</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="c1"># ...</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="25">2.5 æŸ¥è¯¢æ“ä½œ</h3>
<h4 id="cjk-unified-ideograph-57facjk-unified-ideograph-672ccjk-unified-ideograph-67e5cjk-unified-ideograph-8be2">åŸºæœ¬æŸ¥è¯¢</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># æŸ¥è¯¢å•ä¸ª</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="c1"># æŸ¥è¯¢å¤šä¸ª</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># æ¡ä»¶æŸ¥è¯¢</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">,</span>
    <span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span>
<span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="c1"># æ’åºå’Œåˆ†é¡µ</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span>\
    <span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">skip</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<h4 id="cjk-unified-ideograph-5173cjk-unified-ideograph-8054cjk-unified-ideograph-67e5cjk-unified-ideograph-8be2">å…³è”æŸ¥è¯¢</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># é¢„åŠ è½½å…³è”æ•°æ®</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">tasks</span><span class="p">))</span>\
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="c1"># è¿æ¥æŸ¥è¯¢</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Task</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">Task</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;completed&quot;</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></div>

<h3 id="26">2.6 äº‹åŠ¡ç®¡ç†</h3>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">database</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="k">raise</span>
</code></pre></div>

<h3 id="27">2.7 å­¦ä¹ è¦ç‚¹</h3>
<ol>
<li><strong>æ¨¡å‹è®¾è®¡</strong>: åˆç†è®¾è®¡æ¨¡å‹ç»“æ„ï¼Œè€ƒè™‘æ€§èƒ½å’Œæ‰©å±•æ€§</li>
<li><strong>ç´¢å¼•ä¼˜åŒ–</strong>: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•</li>
<li><strong>å…³ç³»ç®¡ç†</strong>: æ­£ç¡®ä½¿ç”¨ relationshipï¼Œé¿å… N+1 æŸ¥è¯¢</li>
<li><strong>è¿ç§»ç®¡ç†</strong>: ä½¿ç”¨ Alembic ç®¡ç†æ•°æ®åº“ç‰ˆæœ¬ï¼Œä¿æŒä¸€è‡´æ€§</li>
<li><strong>è¿æ¥æ± </strong>: é…ç½®åˆé€‚çš„è¿æ¥æ± å¤§å°å’Œå›æ”¶æ—¶é—´</li>
</ol>
<hr />
<h2 id="3-redis">3. Redis ç¼“å­˜ä¸è¿æ¥æ± ç®¡ç†</h2>
<h3 id="31-redis">3.1 Redis åŸºç¡€</h3>
<p>Redis æ˜¯ä¸€ä¸ªå¼€æºçš„å†…å­˜æ•°æ®ç»“æ„å­˜å‚¨ï¼Œç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ã€‚</p>
<h4 id="cjk-unified-ideograph-9879cjk-unified-ideograph-76eecjk-unified-ideograph-4e2dcjk-unified-ideograph-7684cjk-unified-ideograph-7528cjk-unified-ideograph-9014">é¡¹ç›®ä¸­çš„ç”¨é€”</h4>
<ol>
<li><strong>ç¼“å­˜</strong>: å­˜å‚¨éªŒè¯ç ã€ä¼šè¯æ•°æ®</li>
<li><strong>ä»¤ç‰Œé»‘åå•</strong>: JWT ä»¤ç‰Œæ’¤é”€</li>
<li><strong>Celery æ¶ˆæ¯é˜Ÿåˆ—</strong>: ä»»åŠ¡æ¶ˆæ¯ä»£ç†å’Œç»“æœåç«¯</li>
<li><strong>è®¡æ•°å™¨</strong>: é™æµã€ç»Ÿè®¡</li>
</ol>
<h3 id="32-redis">3.2 Redis è¿æ¥æ± ç®¡ç†</h3>
<p>é¡¹ç›®å®ç°äº†å®Œæ•´çš„ Redis è¿æ¥æ± ç®¡ç†ï¼Œæ”¯æŒåŠ¨æ€é…ç½®å’Œå¥åº·æ£€æŸ¥ã€‚</p>
<h4 id="cjk-unified-ideograph-8fdecjk-unified-ideograph-63a5cjk-unified-ideograph-6c60cjk-unified-ideograph-5b9ecjk-unified-ideograph-73b0">è¿æ¥æ± å®ç°</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># app/core/redis_client.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RedisManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Redisè¿æ¥ç®¡ç†å™¨&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_connection</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆå§‹åŒ–Redisè¿æ¥æ± &quot;&quot;&quot;</span>
        <span class="n">max_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_optimal_connections</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">redis_url</span><span class="p">,</span>
            <span class="n">max_connections</span><span class="o">=</span><span class="n">max_connections</span><span class="p">,</span>
            <span class="n">retry_on_timeout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">socket_keepalive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">health_check_interval</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">socket_connect_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">socket_timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">connection_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>  <span class="c1"># æµ‹è¯•è¿æ¥</span>
</code></pre></div>

<h4 id="cjk-unified-ideograph-8fdecjk-unified-ideograph-63a5cjk-unified-ideograph-6c60cjk-unified-ideograph-5927cjk-unified-ideograph-5c0fcjk-unified-ideograph-4f18cjk-unified-ideograph-5316">è¿æ¥æ± å¤§å°ä¼˜åŒ–</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_optimal_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ ¹æ®ç¯å¢ƒè·å–æœ€ä¼˜è¿æ¥æ•°&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">10</span>  <span class="c1"># å¼€å‘ç¯å¢ƒ</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># ç”Ÿäº§ç¯å¢ƒï¼šæ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´</span>
        <span class="n">cpu_count</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="n">connections_per_cpu</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">optimal_connections</span> <span class="o">=</span> <span class="n">cpu_count</span> <span class="o">*</span> <span class="n">connections_per_cpu</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">optimal_connections</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div>

<h3 id="33-redis">3.3 Redis æ“ä½œ</h3>
<h4 id="cjk-unified-ideograph-57facjk-unified-ideograph-672ccjk-unified-ideograph-64cdcjk-unified-ideograph-4f5c">åŸºæœ¬æ“ä½œ</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># è®¾ç½®å€¼ï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰</span>
<span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>  <span class="c1"># 300ç§’è¿‡æœŸ</span>

<span class="c1"># è·å–å€¼</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>

<span class="c1"># åˆ é™¤é”®</span>
<span class="n">redis_client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>

<span class="c1"># æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨</span>
<span class="n">exists</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>

<span class="c1"># è®¾ç½®è¿‡æœŸæ—¶é—´</span>
<span class="n">redis_client</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
</code></pre></div>

<h4 id="cjk-unified-ideograph-9879cjk-unified-ideograph-76eecjk-unified-ideograph-4e2dcjk-unified-ideograph-7684cjk-unified-ideograph-5e94cjk-unified-ideograph-7528cjk-unified-ideograph-573acjk-unified-ideograph-666f">é¡¹ç›®ä¸­çš„åº”ç”¨åœºæ™¯</h4>
<ol>
<li><strong>çŸ­ä¿¡éªŒè¯ç å­˜å‚¨</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># å­˜å‚¨éªŒè¯ç ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰</span>
<span class="n">redis_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sms_verification:</span><span class="si">{</span><span class="n">mobile</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_key</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>

<span class="c1"># éªŒè¯éªŒè¯ç </span>
<span class="n">stored_code</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>
<span class="k">if</span> <span class="n">stored_code</span> <span class="ow">and</span> <span class="n">stored_code</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">code</span><span class="p">:</span>
    <span class="n">redis_client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>  <span class="c1"># éªŒè¯ååˆ é™¤</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<ol>
<li><strong>JWT ä»¤ç‰Œé»‘åå•</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># å°†ä»¤ç‰ŒåŠ å…¥é»‘åå•</span>
<span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;blacklist:</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">expires_in</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>

<span class="c1"># æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•</span>
<span class="n">is_blacklisted</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;blacklist:</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<ol>
<li><strong>ç”¨æˆ·ç™»å‡ºæ ‡è®°</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># æ ‡è®°ç”¨æˆ·å·²ç™»å‡ºï¼ˆ7å¤©æœ‰æ•ˆï¼‰</span>
<span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;user_logout:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>

<span class="c1"># æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å‡º</span>
<span class="n">is_logged_out</span> <span class="o">=</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;user_logout:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<h3 id="34">3.4 è¿æ¥æ± ç›‘æ§</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_pool_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è·å–è¿æ¥æ± ç»Ÿè®¡ä¿¡æ¯&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;max_connections&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">max_connections</span><span class="p">,</span>
        <span class="s2">&quot;current_connections&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">_connections</span><span class="p">),</span>
        <span class="s2">&quot;available_connections&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">max_connections</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">_connections</span><span class="p">),</span>
        <span class="s2">&quot;connection_usage&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">_connections</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">max_connections</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="35">3.5 æ•…éšœå¤„ç†</h3>
<p>é¡¹ç›®å®ç°äº† Mock Redis å®¢æˆ·ç«¯ï¼Œå½“ Redis ä¸å¯ç”¨æ—¶ä»å¯è¿è¡Œï¼ˆåŠŸèƒ½å—é™ï¼‰ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">_MockRedisClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ¨¡æ‹ŸRediså®¢æˆ·ç«¯ï¼Œå½“Redisä¸å¯ç”¨æ—¶ä½¿ç”¨&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æ¨¡æ‹ŸRedisæ“ä½œ: setex </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<h3 id="36">3.6 å­¦ä¹ è¦ç‚¹</h3>
<ol>
<li><strong>è¿æ¥æ± ç®¡ç†</strong>: ä½¿ç”¨è¿æ¥æ± é¿å…é¢‘ç¹åˆ›å»ºè¿æ¥</li>
<li><strong>è¿‡æœŸæ—¶é—´</strong>: åˆç†è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´ï¼Œé¿å…å†…å­˜æ³„æ¼</li>
<li><strong>é”®å‘½åè§„èŒƒ</strong>: ä½¿ç”¨ç»Ÿä¸€çš„å‰ç¼€å’Œå‘½åè§„èŒƒ</li>
<li><strong>æ•…éšœå¤„ç†</strong>: å®ç°é™çº§ç­–ç•¥ï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§</li>
<li><strong>ç›‘æ§</strong>: ç›‘æ§è¿æ¥æ± ä½¿ç”¨æƒ…å†µï¼ŒåŠæ—¶å‘ç°é—®é¢˜</li>
</ol>
<hr />
<h2 id="4-celery">4. Celery å¼‚æ­¥ä»»åŠ¡å¤„ç†</h2>
<h3 id="41-celery">4.1 Celery æ ¸å¿ƒæ¦‚å¿µ</h3>
<p>Celery æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨äºå¤„ç†å¼‚æ­¥ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ã€‚</p>
<h4 id="cjk-unified-ideograph-6838cjk-unified-ideograph-5fc3cjk-unified-ideograph-7ec4cjk-unified-ideograph-4ef6">æ ¸å¿ƒç»„ä»¶</h4>
<ul>
<li><strong>Broker</strong>: æ¶ˆæ¯ä»£ç†ï¼ˆé¡¹ç›®ä¸­ä½¿ç”¨ Redisï¼‰</li>
<li><strong>Worker</strong>: å·¥ä½œè¿›ç¨‹ï¼Œæ‰§è¡Œä»»åŠ¡</li>
<li><strong>Backend</strong>: ç»“æœåç«¯ï¼Œå­˜å‚¨ä»»åŠ¡ç»“æœï¼ˆé¡¹ç›®ä¸­ä½¿ç”¨ Redisï¼‰</li>
</ul>
<h3 id="42-celery">4.2 Celery é…ç½®</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># app/core/celery_app.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>

<span class="n">celery_app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span>
    <span class="s2">&quot;data_station_api&quot;</span><span class="p">,</span>
    <span class="n">broker</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">celery_broker_url</span><span class="p">,</span>
    <span class="n">backend</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">celery_result_backend</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">celery_app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">task_serializer</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span>
    <span class="n">accept_content</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">],</span>
    <span class="n">result_serializer</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span>
    <span class="n">timezone</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">,</span>
    <span class="n">enable_utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">task_track_started</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">task_time_limit</span><span class="o">=</span><span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>  <span class="c1"># 30åˆ†é’Ÿè¶…æ—¶</span>
    <span class="n">broker_connection_retry_on_startup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">result_expires</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>  <span class="c1"># ç»“æœè¿‡æœŸæ—¶é—´1å°æ—¶</span>
    <span class="n">worker_prefetch_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">task_acks_late</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="43">4.3 ä»»åŠ¡å®šä¹‰</h3>
<p>ä½¿ç”¨è£…é¥°å™¨å®šä¹‰ Celery ä»»åŠ¡ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ç®€å•ä»»åŠ¡</span>
<span class="nd">@celery_app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;health_check_task&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">health_check_task</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">}</span>

<span class="c1"># å¤æ‚ä»»åŠ¡ï¼ˆæ”¯æŒçŠ¶æ€æ›´æ–°ï¼‰</span>
<span class="nd">@celery_app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fetch_data_task&quot;</span><span class="p">,</span>
    <span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># ç»‘å®šä»»åŠ¡å®ä¾‹ï¼Œå¯è®¿é—® self</span>
    <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">default_retry_delay</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,),</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_data_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span>

    <span class="c1"># æ›´æ–°ä»»åŠ¡çŠ¶æ€</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span>
        <span class="n">state</span><span class="o">=</span><span class="s2">&quot;PROCESSING&quot;</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;å¼€å§‹å¤„ç†&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># ä»»åŠ¡é€»è¾‘</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span>
                <span class="n">state</span><span class="o">=</span><span class="s2">&quot;PROCESSING&quot;</span><span class="p">,</span>
                <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="n">progress</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;å¤„ç†æ­¥éª¤ </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span>
            <span class="n">state</span><span class="o">=</span><span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span>
            <span class="n">state</span><span class="o">=</span><span class="s2">&quot;FAILURE&quot;</span><span class="p">,</span>
            <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div>

<h3 id="44">4.4 ä»»åŠ¡æäº¤å’ŒæŸ¥è¯¢</h3>
<h4 id="cjk-unified-ideograph-63d0cjk-unified-ideograph-4ea4cjk-unified-ideograph-4efbcjk-unified-ideograph-52a1">æäº¤ä»»åŠ¡</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># åœ¨ API ç«¯ç‚¹ä¸­æäº¤ä»»åŠ¡</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.celery_app</span><span class="w"> </span><span class="kn">import</span> <span class="n">celery_app</span>

<span class="n">task</span> <span class="o">=</span> <span class="n">celery_app</span><span class="o">.</span><span class="n">send_task</span><span class="p">(</span>
    <span class="s2">&quot;fetch_data_task&quot;</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">task_params</span><span class="p">],</span>
    <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span>  <span class="c1"># å»¶è¿Ÿ10ç§’æ‰§è¡Œ</span>
<span class="p">)</span>

<span class="n">task_id</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span>
</code></pre></div>

<h4 id="cjk-unified-ideograph-67e5cjk-unified-ideograph-8be2cjk-unified-ideograph-4efbcjk-unified-ideograph-52a1cjk-unified-ideograph-72b6cjk-unified-ideograph-6001">æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.result</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncResult</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">AsyncResult</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">celery_app</span><span class="p">)</span>

<span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">successful</span><span class="p">():</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">info</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># ä»»åŠ¡è¿˜åœ¨è¿è¡Œï¼Œè·å–å½“å‰çŠ¶æ€</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">state</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">info</span>
</code></pre></div>

<h3 id="45">4.5 ä»»åŠ¡çŠ¶æ€ç®¡ç†</h3>
<p>é¡¹ç›®åœ¨æ•°æ®åº“ä¸­å­˜å‚¨ä»»åŠ¡çŠ¶æ€ï¼Œä¸ Celery çŠ¶æ€åŒæ­¥ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/models/task.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TaskStatus</span><span class="p">:</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
    <span class="n">QUEUED</span> <span class="o">=</span> <span class="s2">&quot;queued&quot;</span>
    <span class="n">PROCESSING</span> <span class="o">=</span> <span class="s2">&quot;processing&quot;</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
    <span class="n">EXPIRED</span> <span class="o">=</span> <span class="s2">&quot;expired&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">uuid</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">36</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;users.id&quot;</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">TaskStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">)</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">JSON</span><span class="p">)</span>
    <span class="n">error_message</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
</code></pre></div>

<h3 id="46-worker">4.6 Worker å¯åŠ¨</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># celery_worker.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.celery_app</span><span class="w"> </span><span class="kn">import</span> <span class="n">celery_app</span>

<span class="n">celery_app</span><span class="o">.</span><span class="n">worker_main</span><span class="p">([</span>
    <span class="s2">&quot;worker&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--loglevel=info&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--concurrency=2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--queues=default&quot;</span><span class="p">,</span>
<span class="p">])</span>
</code></pre></div>

<p>å¯åŠ¨å‘½ä»¤ï¼š</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>celery_worker.py
<span class="c1"># æˆ–</span>
celery<span class="w"> </span>-A<span class="w"> </span>app.core.celery_app<span class="w"> </span>worker<span class="w"> </span>--loglevel<span class="o">=</span>info
</code></pre></div>

<h3 id="47">4.7 ä»»åŠ¡å–æ¶ˆ</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># å–æ¶ˆä»»åŠ¡</span>
<span class="n">celery_app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># åœ¨æ•°æ®åº“ä¸­æ›´æ–°çŠ¶æ€</span>
<span class="n">TaskService</span><span class="o">.</span><span class="n">update_task_status</span><span class="p">(</span>
    <span class="n">database</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">CANCELLED</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="48">4.8 å­¦ä¹ è¦ç‚¹</h3>
<ol>
<li><strong>ä»»åŠ¡è®¾è®¡</strong>: ä»»åŠ¡åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼Œæ”¯æŒé‡è¯•</li>
<li><strong>çŠ¶æ€æ›´æ–°</strong>: åŠæ—¶æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼Œæ–¹ä¾¿ç”¨æˆ·æŸ¥è¯¢è¿›åº¦</li>
<li><strong>é”™è¯¯å¤„ç†</strong>: å®ç°å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶</li>
<li><strong>èµ„æºç®¡ç†</strong>: æ³¨æ„ Worker çš„èµ„æºä½¿ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼</li>
<li><strong>ç›‘æ§</strong>: ç›‘æ§ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼ŒåŠæ—¶å‘ç°é—®é¢˜</li>
</ol>
<hr />
<h2 id="5-jwt">5. JWT è®¤è¯ä¸å®‰å…¨æœºåˆ¶</h2>
<h3 id="51-jwt">5.1 JWT åŸºç¡€</h3>
<p>JWT (JSON Web Token) æ˜¯ä¸€ç§å¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œç”¨äºå®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ã€‚</p>
<h4 id="jwt">JWT ç»“æ„</h4>
<p>JWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š<br />
- <strong>Header</strong>: ç®—æ³•å’Œä»¤ç‰Œç±»å‹<br />
- <strong>Payload</strong>: æ•°æ®ï¼ˆç”¨æˆ·ä¿¡æ¯ã€è¿‡æœŸæ—¶é—´ç­‰ï¼‰<br />
- <strong>Signature</strong>: ç­¾åï¼Œç”¨äºéªŒè¯ä»¤ç‰Œ</p>
<h4 id="jwt_1">é¡¹ç›®ä¸­çš„ JWT é…ç½®</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># app/core/config.py</span>
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SECRET_KEY&quot;</span><span class="p">)</span>
<span class="n">ALGORITHM</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
<span class="n">ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">REFRESH_TOKEN_EXPIRE_DAYS</span> <span class="o">=</span> <span class="mi">7</span>
</code></pre></div>

<h3 id="52">5.2 ä»¤ç‰Œç”Ÿæˆ</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># app/core/security.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºè®¿é—®ä»¤ç‰Œ&quot;&quot;&quot;</span>
    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">expires_delta</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
            <span class="n">minutes</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">access_token_expire_minutes</span>
        <span class="p">)</span>

    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;access&quot;</span>  <span class="c1"># ä»¤ç‰Œç±»å‹</span>
    <span class="p">})</span>

    <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="n">to_encode</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">algorithm</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">encoded_jwt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_refresh_token</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºåˆ·æ–°ä»¤ç‰Œ&quot;&quot;&quot;</span>
    <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
        <span class="n">days</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">refresh_token_expire_days</span>
    <span class="p">)</span>

    <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh&quot;</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
</code></pre></div>

<h3 id="53">5.3 ä»¤ç‰ŒéªŒè¯</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;éªŒè¯ä»¤ç‰Œ&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># æ£€æŸ¥é»‘åå•</span>
        <span class="k">if</span> <span class="n">is_token_blacklisted</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ä»¤ç‰Œå·²è¢«æ³¨é”€&quot;</span>
            <span class="p">)</span>

        <span class="c1"># è§£ç ä»¤ç‰Œ</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">token</span><span class="p">,</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span>
            <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">algorithm</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
        <span class="n">token_type</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">username</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">token_type</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;æ— æ•ˆçš„ä»¤ç‰Œ&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TokenData</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ä»¤ç‰Œå·²è¿‡æœŸ&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;æ— æ•ˆçš„ä»¤ç‰Œ&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="54">5.4 ä»¤ç‰Œé»‘åå•æœºåˆ¶</h3>
<p>é¡¹ç›®å®ç°äº†ä»¤ç‰Œé»‘åå•ï¼Œç”¨äºç™»å‡ºæ—¶æ’¤é”€ä»¤ç‰Œã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_token_to_blacklist</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expires_in</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1800</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å°†ä»¤ç‰Œæ·»åŠ åˆ°é»‘åå•&quot;&quot;&quot;</span>
    <span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;blacklist:</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">expires_in</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">is_token_blacklisted</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;blacklist:</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<h3 id="55">5.5 ç”¨æˆ·è®¤è¯ä¾èµ–</h3>
<p>ä½¿ç”¨ FastAPI çš„ä¾èµ–æ³¨å…¥å®ç°è®¤è¯ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
    <span class="n">credentials</span><span class="p">:</span> <span class="n">HTTPAuthorizationCredentials</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">security</span><span class="p">),</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è·å–å½“å‰ç”¨æˆ·&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span>
    <span class="n">token_data</span> <span class="o">=</span> <span class="n">verify_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="c1"># æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å‡º</span>
    <span class="k">if</span> <span class="n">is_user_logged_out</span><span class="p">(</span><span class="n">token_data</span><span class="o">.</span><span class="n">user_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ç”¨æˆ·å·²ç™»å‡º&quot;</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">token_data</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">user</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_current_admin_user</span><span class="p">(</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è·å–å½“å‰ç®¡ç†å‘˜ç”¨æˆ·&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">UserRole</span><span class="o">.</span><span class="n">ADMIN</span><span class="p">,</span> <span class="n">UserRole</span><span class="o">.</span><span class="n">SUPER_ADMIN</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;éœ€è¦ç®¡ç†å‘˜æƒé™&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">current_user</span>
</code></pre></div>

<h3 id="56">5.6 å¯†ç åŠ å¯†</h3>
<p>ä½¿ç”¨ bcrypt è¿›è¡Œå¯†ç å“ˆå¸Œã€‚</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">passlib.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">CryptContext</span>

<span class="n">pwd_context</span> <span class="o">=</span> <span class="n">CryptContext</span><span class="p">(</span><span class="n">schemes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;bcrypt&quot;</span><span class="p">],</span> <span class="n">deprecated</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;è·å–å¯†ç å“ˆå¸Œ&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pwd_context</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="n">plain_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;éªŒè¯å¯†ç &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pwd_context</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</code></pre></div>

<h3 id="57">5.7 ç™»å½•æµç¨‹</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span>
    <span class="n">user_data</span><span class="p">:</span> <span class="n">UserLogin</span><span class="p">,</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">),</span>
<span class="p">):</span>
    <span class="c1"># éªŒè¯ç”¨æˆ·</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate_user</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">user_data</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">user_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;</span><span class="p">)</span>

    <span class="c1"># åˆ›å»ºä»¤ç‰Œ</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">create_tokens</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tokens</span>
</code></pre></div>

<h3 id="58">5.8 åˆ·æ–°ä»¤ç‰Œæµç¨‹</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/refresh&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refresh_token</span><span class="p">(</span>
    <span class="n">token_data</span><span class="p">:</span> <span class="n">TokenRefresh</span><span class="p">,</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">),</span>
<span class="p">):</span>
    <span class="c1"># éªŒè¯åˆ·æ–°ä»¤ç‰Œ</span>
    <span class="n">token_data_obj</span> <span class="o">=</span> <span class="n">verify_token</span><span class="p">(</span><span class="n">token_data</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">)</span>

    <span class="c1"># æ£€æŸ¥ä»¤ç‰Œç±»å‹</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
        <span class="n">token_data</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span>
        <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">settings</span><span class="o">.</span><span class="n">algorithm</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;refresh&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;éœ€è¦åˆ·æ–°ä»¤ç‰Œ&quot;</span><span class="p">)</span>

    <span class="c1"># è·å–ç”¨æˆ·</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">token_data_obj</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="c1"># ç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œ</span>
    <span class="n">new_tokens</span> <span class="o">=</span> <span class="n">create_access_token_only</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_tokens</span>
</code></pre></div>

<h3 id="59">5.9 ç™»å‡ºæµç¨‹</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/logout&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">(</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">),</span>
    <span class="n">credentials</span><span class="p">:</span> <span class="n">HTTPAuthorizationCredentials</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">security</span><span class="p">),</span>
<span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span>

    <span class="c1"># å°†å½“å‰ä»¤ç‰ŒåŠ å…¥é»‘åå•</span>
    <span class="n">logout_user</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="c1"># æ’¤é”€ç”¨æˆ·æ‰€æœ‰ä»¤ç‰Œï¼ˆå¯é€‰ï¼‰</span>
    <span class="n">logout_user_all_tokens</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;ç™»å‡ºæˆåŠŸ&quot;</span><span class="p">}</span>
</code></pre></div>

<h3 id="510">5.10 å­¦ä¹ è¦ç‚¹</h3>
<ol>
<li><strong>å¯†é’¥ç®¡ç†</strong>: ä½¿ç”¨å¼ºå¯†é’¥ï¼Œä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç </li>
<li><strong>ä»¤ç‰Œè¿‡æœŸ</strong>: è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œå¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ</li>
<li><strong>ä»¤ç‰Œæ’¤é”€</strong>: å®ç°ä»¤ç‰Œé»‘åå•æˆ–ç”¨æˆ·çº§åˆ«æ’¤é”€</li>
<li><strong>å¯†ç å®‰å…¨</strong>: ä½¿ç”¨ bcrypt ç­‰å®‰å…¨å“ˆå¸Œç®—æ³•</li>
<li><strong>HTTPS</strong>: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS ä¼ è¾“ä»¤ç‰Œ</li>
</ol>
<hr />
<h2 id="6">6. é¡¹ç›®æ¶æ„è®¾è®¡æ¨¡å¼</h2>
<h3 id="61">6.1 åˆ†å±‚æ¶æ„</h3>
<p>é¡¹ç›®é‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼š</p>
<div class="highlight"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API å±‚ (endpoints/)           â”‚  â† å¤„ç† HTTP è¯·æ±‚/å“åº”
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æœåŠ¡å±‚ (services/)            â”‚  â† ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®è®¿é—®å±‚ (models/)          â”‚  â† æ•°æ®åº“æ“ä½œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="62-api-endpoints">6.2 API å±‚ï¼ˆendpoints/ï¼‰</h3>
<p>è´Ÿè´£å¤„ç† HTTP è¯·æ±‚ï¼Œè°ƒç”¨æœåŠ¡å±‚ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/api/v1/endpoints/users.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/me&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user_info</span><span class="p">(</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">),</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="63-services">6.3 æœåŠ¡å±‚ï¼ˆservices/ï¼‰</h3>
<p>åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œå¯è¢«å¤šä¸ªç«¯ç‚¹å¤ç”¨ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/services/user_service.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserService</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_user_by_username</span><span class="p">(</span><span class="n">database</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">User</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">database</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="o">**</span><span class="n">user_data</span><span class="p">)</span>
        <span class="n">database</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">database</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">database</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>
</code></pre></div>

<h3 id="64-models">6.4 æ•°æ®æ¨¡å‹å±‚ï¼ˆmodels/ï¼‰</h3>
<p>å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/models/user.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>
    <span class="c1"># ... å­—æ®µå®šä¹‰</span>
</code></pre></div>

<h3 id="65-schemas">6.5 æ•°æ®éªŒè¯å±‚ï¼ˆschemas/ï¼‰</h3>
<p>ä½¿ç”¨ Pydantic å®šä¹‰è¯·æ±‚/å“åº”æ•°æ®ç»“æ„ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/schemas/user.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserRegister</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>

<h3 id="66">6.6 ä¾èµ–æ³¨å…¥æ¨¡å¼</h3>
<p>å¤§é‡ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œæé«˜ä»£ç å¯æµ‹è¯•æ€§ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># æ•°æ®åº“ä¾èµ–</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_database</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLocal</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">db</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># è®¤è¯ä¾èµ–</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
    <span class="n">credentials</span><span class="p">:</span> <span class="n">HTTPAuthorizationCredentials</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">security</span><span class="p">),</span>
    <span class="n">database</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
    <span class="c1"># ...</span>
</code></pre></div>

<h3 id="67">6.7 é…ç½®ç®¡ç†</h3>
<p>é›†ä¸­ç®¡ç†é…ç½®ï¼Œä»ç¯å¢ƒå˜é‡è¯»å–ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/core/config.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">:</span>
    <span class="n">database_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_URL&quot;</span><span class="p">)</span>
    <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SECRET_KEY&quot;</span><span class="p">)</span>
    <span class="c1"># ...</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
</code></pre></div>

<h3 id="68">6.8 é”™è¯¯å¤„ç†</h3>
<p>ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># ä¸šåŠ¡é€»è¾‘</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
        <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>

<h3 id="69">6.9 æ—¥å¿—ç³»ç»Ÿ</h3>
<p>ä½¿ç”¨ loguru è¿›è¡Œæ—¥å¿—è®°å½•ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ç”¨æˆ·ç™»å½•æˆåŠŸ&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;é”™è¯¯ä¿¡æ¯: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;è°ƒè¯•ä¿¡æ¯: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="610">6.10 å­¦ä¹ è¦ç‚¹</h3>
<ol>
<li><strong>å•ä¸€èŒè´£</strong>: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½</li>
<li><strong>ä¾èµ–æ³¨å…¥</strong>: ä½¿ç”¨ä¾èµ–æ³¨å…¥æé«˜å¯æµ‹è¯•æ€§</li>
<li><strong>åˆ†å±‚æ¸…æ™°</strong>: ä¿æŒå±‚æ¬¡æ¸…æ™°ï¼Œé¿å…è·¨å±‚è°ƒç”¨</li>
<li><strong>é…ç½®é›†ä¸­</strong>: é›†ä¸­ç®¡ç†é…ç½®ï¼Œä¾¿äºç»´æŠ¤</li>
<li><strong>é”™è¯¯å¤„ç†</strong>: ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼Œæä¾›å‹å¥½é”™è¯¯ä¿¡æ¯</li>
</ol>
<hr />
<h2 id="7">7. äº‘æœåŠ¡é›†æˆ</h2>
<h3 id="71">7.1 é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡</h3>
<p>ç”¨äºå‘é€çŸ­ä¿¡éªŒè¯ç ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/core/sms.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alibabacloud_dysmsapi20170525.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span> <span class="k">as</span> <span class="n">DysmsapiClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_message_code</span><span class="p">(</span><span class="n">mobile</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å‘é€çŸ­ä¿¡éªŒè¯ç &quot;&quot;&quot;</span>
    <span class="c1"># åˆå§‹åŒ–å®¢æˆ·ç«¯</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">open_api_models</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span>
        <span class="n">access_key_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ali_access_key_id</span><span class="p">,</span>
        <span class="n">access_key_secret</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ali_access_key_secret</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">DysmsapiClient</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># ç”ŸæˆéªŒè¯ç </span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">999999</span><span class="p">))</span>

    <span class="c1"># å‘é€çŸ­ä¿¡</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">dysmsapi_20170525_models</span><span class="o">.</span><span class="n">SendSmsRequest</span><span class="p">(</span>
        <span class="n">phone_numbers</span><span class="o">=</span><span class="n">mobile</span><span class="p">,</span>
        <span class="n">template_code</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">aliyun_sms_template_code</span><span class="p">,</span>
        <span class="n">template_param</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">}),</span>
        <span class="n">sign_name</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">aliyun_sms_sign_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">send_sms_with_options</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">runtime</span><span class="p">)</span>

    <span class="c1"># å­˜å‚¨éªŒè¯ç åˆ° Redisï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰</span>
    <span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sms_verification:</span><span class="si">{</span><span class="n">mobile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<h3 id="72">7.2 é˜¿é‡Œäº‘é‚®ä»¶æœåŠ¡</h3>
<p>ç”¨äºå‘é€éªŒè¯é‚®ä»¶ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/core/alimail.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alibabacloud_dm20151123.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span> <span class="k">as</span> <span class="n">DmClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_verification_email</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verification_link</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å‘é€éªŒè¯é‚®ä»¶&quot;&quot;&quot;</span>
    <span class="c1"># åˆå§‹åŒ–å®¢æˆ·ç«¯</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">open_api_models</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span>
        <span class="n">access_key_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ali_access_key_id</span><span class="p">,</span>
        <span class="n">access_key_secret</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ali_access_key_secret</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">DmClient</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># æ„å»ºé‚®ä»¶å†…å®¹</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">dm_20151123_models</span><span class="o">.</span><span class="n">SingleSendMailRequest</span><span class="p">(</span>
        <span class="n">account_name</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ali_mail_account_name</span><span class="p">,</span>
        <span class="n">to_address</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
        <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;é‚®ç®±éªŒè¯&quot;</span><span class="p">,</span>
        <span class="n">html_body</span><span class="o">=</span><span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;verification.html&quot;</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="n">verification_link</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">client</span><span class="o">.</span><span class="n">single_send_mail_with_options</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">runtime</span><span class="p">)</span>
</code></pre></div>

<h3 id="73">7.3 è…¾è®¯äº‘éªŒè¯ç </h3>
<p>ç”¨äºéªŒè¯ç”¨æˆ·æäº¤çš„éªŒè¯ç ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># app/core/tencent_captcha.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tencentcloud.common.credential</span><span class="w"> </span><span class="kn">import</span> <span class="n">Credential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tencentcloud.captcha.v20190722</span><span class="w"> </span><span class="kn">import</span> <span class="n">captcha_client</span><span class="p">,</span> <span class="n">models</span>

<span class="k">def</span><span class="w"> </span><span class="nf">verify_tencent_captcha</span><span class="p">(</span><span class="n">ticket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">randstr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;éªŒè¯è…¾è®¯éªŒè¯ç &quot;&quot;&quot;</span>
    <span class="n">cred</span> <span class="o">=</span> <span class="n">Credential</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">tencent_secret_id</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">tencent_secret_key</span>
    <span class="p">)</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">captcha_client</span><span class="o">.</span><span class="n">CaptchaClient</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="s2">&quot;ap-shanghai&quot;</span><span class="p">)</span>

    <span class="n">req</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DescribeCaptchaResultRequest</span><span class="p">()</span>
    <span class="n">req</span><span class="o">.</span><span class="n">CaptchaType</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">req</span><span class="o">.</span><span class="n">Ticket</span> <span class="o">=</span> <span class="n">ticket</span>
    <span class="n">req</span><span class="o">.</span><span class="n">UserIp</span> <span class="o">=</span> <span class="n">user_ip</span>
    <span class="n">req</span><span class="o">.</span><span class="n">CaptchaAppId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">tencent_captcha_appid</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">AppSecretKey</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">tencent_app_secretkey</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">DescribeCaptchaResult</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">CaptchaCode</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>

<h3 id="74">7.4 å­¦ä¹ è¦ç‚¹</h3>
<ol>
<li><strong>å¯†é’¥ç®¡ç†</strong>: ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥ï¼Œä¸è¦ç¡¬ç¼–ç </li>
<li><strong>é”™è¯¯å¤„ç†</strong>: å¤„ç†æœåŠ¡è°ƒç”¨å¤±è´¥çš„æƒ…å†µ</li>
<li><strong>é™æµ</strong>: å®ç°å‘é€é¢‘ç‡é™åˆ¶ï¼Œé˜²æ­¢æ»¥ç”¨</li>
<li><strong>æˆæœ¬æ§åˆ¶</strong>: ç›‘æ§æœåŠ¡ä½¿ç”¨é‡ï¼Œæ§åˆ¶æˆæœ¬</li>
<li><strong>é™çº§ç­–ç•¥</strong>: æœåŠ¡ä¸å¯ç”¨æ—¶æä¾›é™çº§æ–¹æ¡ˆ</li>
</ol>
<hr />
<h2 id="8">8. æµ‹è¯•ä¸éƒ¨ç½²</h2>
<h3 id="81">8.1 æµ‹è¯•æ¡†æ¶</h3>
<p>ä½¿ç”¨ pytest è¿›è¡Œæµ‹è¯•ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/conftest.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.core.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">SessionLocal</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">():</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
    <span class="k">return</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">database</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">SessionLocal</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">db</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<h3 id="82">8.2 å•å…ƒæµ‹è¯•ç¤ºä¾‹</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># tests/api/v1/endpoints/test_auth.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_register_user</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;/api/v1/auth/register&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;testuser&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password123&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sms_code&quot;</span><span class="p">:</span> <span class="s2">&quot;123456&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="k">assert</span> <span class="s2">&quot;access_token&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<h3 id="83-docker">8.3 Docker éƒ¨ç½²</h3>
<div class="highlight"><pre><span></span><code><span class="c"># Dockerfile</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11-slim</span>

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># å®‰è£…ä¾èµ–</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># å¤åˆ¶ä»£ç </span>
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.

<span class="c"># æš´éœ²ç«¯å£</span>
<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8000</span>

<span class="c"># å¯åŠ¨å‘½ä»¤</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;main:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--host&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--port&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;8000&quot;</span><span class="p">]</span>
</code></pre></div>

<h3 id="84">8.4 ç¯å¢ƒé…ç½®</h3>
<p>ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†é…ç½®ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># .env æ–‡ä»¶</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://user:pass@localhost/db
<span class="nv">SECRET_KEY</span><span class="o">=</span>your-secret-key
<span class="nv">REDIS_URL</span><span class="o">=</span>redis://localhost:6379/0
</code></pre></div>

<h3 id="85">8.5 éƒ¨ç½²æµç¨‹</h3>
<ol>
<li>
<p><strong>æ„å»ºé•œåƒ</strong><br />
<code>bash
   docker build -t web-api .</code></p>
</li>
<li>
<p><strong>è¿è¡Œå®¹å™¨</strong><br />
<code>bash
   docker run -d \
     -p 8000:8000 \
     --env-file .env \
     web-api</code></p>
</li>
<li>
<p><strong>æ•°æ®åº“è¿ç§»</strong><br />
<code>bash
   docker exec -it container_name alembic upgrade head</code></p>
</li>
</ol>
<h3 id="86">8.6 å­¦ä¹ è¦ç‚¹</h3>
<ol>
<li><strong>æµ‹è¯•è¦†ç›–</strong>: ç¼–å†™å……åˆ†çš„æµ‹è¯•ï¼Œè¦†ç›–ä¸»è¦åŠŸèƒ½</li>
<li><strong>CI/CD</strong>: é…ç½®è‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²æµç¨‹</li>
<li><strong>ç›‘æ§</strong>: éƒ¨ç½²ç›‘æ§ç³»ç»Ÿï¼ŒåŠæ—¶å‘ç°é—®é¢˜</li>
<li><strong>æ—¥å¿—</strong>: é…ç½®æ—¥å¿—æ”¶é›†å’Œåˆ†æ</li>
<li><strong>å¤‡ä»½</strong>: å®šæœŸå¤‡ä»½æ•°æ®åº“å’Œé‡è¦æ•°æ®</li>
</ol>
<hr />
<h2 id="9">9. æœ€ä½³å®è·µæ€»ç»“</h2>
<h3 id="91">9.1 ä»£ç ç»„ç»‡</h3>
<ul>
<li>âœ… ä½¿ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„</li>
<li>âœ… ä¿æŒæ¨¡å—èŒè´£å•ä¸€</li>
<li>âœ… ä½¿ç”¨ç±»å‹æç¤ºæé«˜ä»£ç å¯è¯»æ€§</li>
<li>âœ… ç¼–å†™æ¸…æ™°çš„æ–‡æ¡£å­—ç¬¦ä¸²</li>
</ul>
<h3 id="92">9.2 å®‰å…¨å®è·µ</h3>
<ul>
<li>âœ… ä½¿ç”¨ HTTPS ä¼ è¾“æ•æ„Ÿæ•°æ®</li>
<li>âœ… å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†</li>
<li>âœ… å®ç°ä»¤ç‰Œé»‘åå•æœºåˆ¶</li>
<li>âœ… éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥</li>
<li>âœ… è®¾ç½®åˆç†çš„ä»¤ç‰Œè¿‡æœŸæ—¶é—´</li>
</ul>
<h3 id="93">9.3 æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li>âœ… ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± </li>
<li>âœ… ä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®</li>
<li>âœ… å¼‚æ­¥å¤„ç†è€—æ—¶ä»»åŠ¡</li>
<li>âœ… åˆç†ä½¿ç”¨æ•°æ®åº“ç´¢å¼•</li>
</ul>
<h3 id="94">9.4 é”™è¯¯å¤„ç†</h3>
<ul>
<li>âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶</li>
<li>âœ… è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—</li>
<li>âœ… è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯</li>
<li>âœ… å®ç°æ•…éšœé™çº§ç­–ç•¥</li>
</ul>
<h3 id="95">9.5 å¯ç»´æŠ¤æ€§</h3>
<ul>
<li>âœ… ä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†è®¾ç½®</li>
<li>âœ… ä½¿ç”¨ä¾èµ–æ³¨å…¥æé«˜å¯æµ‹è¯•æ€§</li>
<li>âœ… ç¼–å†™æ¸…æ™°çš„æ³¨é‡Šå’Œæ–‡æ¡£</li>
<li>âœ… éµå¾ªä»£ç è§„èŒƒï¼ˆflake8ï¼‰</li>
</ul>
<hr />
<h2 id="open-bookcjk-unified-ideograph-5b66cjk-unified-ideograph-4e60cjk-unified-ideograph-8d44cjk-unified-ideograph-6e90cjk-unified-ideograph-63a8cjk-unified-ideograph-8350">ğŸ“– å­¦ä¹ èµ„æºæ¨è</h2>
<h3 id="cjk-unified-ideograph-5b98cjk-unified-ideograph-65b9cjk-unified-ideograph-6587cjk-unified-ideograph-6863">å®˜æ–¹æ–‡æ¡£</h3>
<ul>
<li><a href="https://fastapi.tiangolo.com/">FastAPI æ–‡æ¡£</a></li>
<li><a href="https://docs.sqlalchemy.org/">SQLAlchemy æ–‡æ¡£</a></li>
<li><a href="https://docs.celeryproject.org/">Celery æ–‡æ¡£</a></li>
<li><a href="https://redis.io/documentation">Redis æ–‡æ¡£</a></li>
<li><a href="https://alembic.sqlalchemy.org/">Alembic æ–‡æ¡£</a></li>
</ul>
<h3 id="cjk-unified-ideograph-76f8cjk-unified-ideograph-5173cjk-unified-ideograph-6280cjk-unified-ideograph-672f">ç›¸å…³æŠ€æœ¯</h3>
<ul>
<li><a href="https://docs.pydantic.dev/">Pydantic æ–‡æ¡£</a></li>
<li><a href="https://jwt.io/">JWT å®˜æ–¹æ–‡æ¡£</a></li>
<li><a href="https://docs.docker.com/">Docker æ–‡æ¡£</a></li>
<li><a href="https://docs.pytest.org/">pytest æ–‡æ¡£</a></li>
</ul>
<hr />
<h2 id="wrenchcjk-unified-ideograph-5b9ecjk-unified-ideograph-8df5cjk-unified-ideograph-7ec3cjk-unified-ideograph-4e60">ğŸ”§ å®è·µç»ƒä¹ </h2>
<h3 id="1-api">ç»ƒä¹  1: åˆ›å»ºæ–°çš„ API ç«¯ç‚¹</h3>
<p>åˆ›å»ºä¸€ä¸ªæ–°çš„ç«¯ç‚¹ï¼Œå®ç°ç”¨æˆ·èµ„æ–™æ›´æ–°åŠŸèƒ½ã€‚</p>
<h3 id="2">ç»ƒä¹  2: å®ç°ç¼“å­˜æœºåˆ¶</h3>
<p>ä¸ºçƒ­ç‚¹æ•°æ®æ·»åŠ  Redis ç¼“å­˜ã€‚</p>
<h3 id="3-celery">ç»ƒä¹  3: æ·»åŠ æ–°çš„ Celery ä»»åŠ¡</h3>
<p>åˆ›å»ºä¸€ä¸ªæ–°çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½ã€‚</p>
<h3 id="4">ç»ƒä¹  4: ç¼–å†™å•å…ƒæµ‹è¯•</h3>
<p>ä¸ºå…³é”®åŠŸèƒ½ç¼–å†™å•å…ƒæµ‹è¯•ã€‚</p>
<hr />
<h2 id="memocjk-unified-ideograph-603bcjk-unified-ideograph-7ed3">ğŸ“ æ€»ç»“</h2>
<p>è¿™ä»½å­¦ä¹ ç¬”è®°æ¶µç›–äº† Data Station Web API é¡¹ç›®ä¸­ä½¿ç”¨çš„æ ¸å¿ƒæŠ€æœ¯ï¼š</p>
<ol>
<li><strong>FastAPI</strong>: ç°ä»£åŒ–çš„å¼‚æ­¥ Web æ¡†æ¶</li>
<li><strong>SQLAlchemy</strong>: å¼ºå¤§çš„ ORM æ¡†æ¶</li>
<li><strong>Redis</strong>: é«˜æ€§èƒ½ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ—</li>
<li><strong>Celery</strong>: åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—</li>
<li><strong>JWT</strong>: å®‰å…¨çš„è®¤è¯æœºåˆ¶</li>
<li><strong>äº‘æœåŠ¡</strong>: çŸ­ä¿¡ã€é‚®ä»¶ã€éªŒè¯ç é›†æˆ</li>
</ol>
<p>é€šè¿‡å­¦ä¹ å’Œå®è·µè¿™äº›æŠ€æœ¯ï¼Œä½ å°†èƒ½å¤Ÿæ„å»ºä¼ä¸šçº§çš„ Web API åº”ç”¨ã€‚</p>
<hr />
<p><strong>æœ€åæ›´æ–°</strong>: 2025å¹´1æœˆ<br />
<strong>ä½œè€…</strong>: åŸºäº Data Station Web API é¡¹ç›®æ•´ç†</p>
    </div>
</body>
</html>