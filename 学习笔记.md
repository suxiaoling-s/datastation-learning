# Data Station Web API æŠ€æœ¯æ ˆå­¦ä¹ ç¬”è®°

> åŸºäº FastAPI + Celery + Redis + PostgreSQL çš„ç°ä»£åŒ– Web API æ¡†æ¶å®Œæ•´æŠ€æœ¯è§£æ

---

## ğŸ“š ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [FastAPI æ¡†æ¶](#1-fastapi-æ¡†æ¶)
3. [SQLAlchemy ORM ä¸æ•°æ®åº“è®¾è®¡](#2-sqlalchemy-orm-ä¸æ•°æ®åº“è®¾è®¡)
4. [Redis ç¼“å­˜ä¸è¿æ¥æ± ç®¡ç†](#3-redis-ç¼“å­˜ä¸è¿æ¥æ± ç®¡ç†)
5. [Celery å¼‚æ­¥ä»»åŠ¡å¤„ç†](#4-celery-å¼‚æ­¥ä»»åŠ¡å¤„ç†)
6. [JWT è®¤è¯ä¸å®‰å…¨æœºåˆ¶](#5-jwt-è®¤è¯ä¸å®‰å…¨æœºåˆ¶)
7. [é¡¹ç›®æ¶æ„è®¾è®¡æ¨¡å¼](#6-é¡¹ç›®æ¶æ„è®¾è®¡æ¨¡å¼)
8. [äº‘æœåŠ¡é›†æˆ](#7-äº‘æœåŠ¡é›†æˆ)
9. [æµ‹è¯•ä¸éƒ¨ç½²](#8-æµ‹è¯•ä¸éƒ¨ç½²)
10. [æœ€ä½³å®è·µæ€»ç»“](#9-æœ€ä½³å®è·µæ€»ç»“)

---

## é¡¹ç›®æ¦‚è¿°

### æŠ€æœ¯æ ˆæ€»è§ˆ

è¿™æ˜¯ä¸€ä¸ªåŸºäº **FastAPI** æ„å»ºçš„ç°ä»£åŒ– Web API æ¡†æ¶ï¼Œé‡‡ç”¨äº†å®Œæ•´çš„ä¼ä¸šçº§æŠ€æœ¯æ ˆï¼š

- **Web æ¡†æ¶**: FastAPI (å¼‚æ­¥ã€é«˜æ€§èƒ½)
- **æ•°æ®åº“**: PostgreSQL + SQLAlchemy ORM
- **æ•°æ®åº“è¿ç§»**: Alembic
- **ç¼“å­˜/æ¶ˆæ¯é˜Ÿåˆ—**: Redis
- **å¼‚æ­¥ä»»åŠ¡**: Celery
- **è®¤è¯æˆæƒ**: JWT (JSON Web Tokens)
- **å¯†ç åŠ å¯†**: bcrypt
- **æ•°æ®éªŒè¯**: Pydantic
- **æ—¥å¿—ç³»ç»Ÿ**: loguru
- **äº‘æœåŠ¡**: é˜¿é‡Œäº‘(çŸ­ä¿¡ã€é‚®ä»¶) + è…¾è®¯äº‘(éªŒè¯ç )
- **å®¹å™¨åŒ–**: Docker
- **æµ‹è¯•æ¡†æ¶**: pytest

### é¡¹ç›®ç»“æ„

```
web-api/
â”œâ”€â”€ app/                    # ä¸»åº”ç”¨ä»£ç 
â”‚   â”œâ”€â”€ api/v1/endpoints/  # API ç«¯ç‚¹
â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒé…ç½®å’Œå·¥å…·
â”‚   â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ schemas/           # æ•°æ®éªŒè¯æ¨¡å¼
â”‚   â””â”€â”€ services/          # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ alembic/               # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ tests/                 # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ scripts/               # å·¥å…·è„šæœ¬
â”œâ”€â”€ main.py                # åº”ç”¨å…¥å£
â””â”€â”€ celery_worker.py       # Celery Worker å¯åŠ¨
```

---

## 1. FastAPI æ¡†æ¶

### 1.1 FastAPI æ ¸å¿ƒæ¦‚å¿µ

FastAPI æ˜¯ä¸€ä¸ªç°ä»£ã€å¿«é€Ÿï¼ˆé«˜æ€§èƒ½ï¼‰çš„ Web æ¡†æ¶ï¼Œç”¨äºæ„å»ºåŸºäºæ ‡å‡† Python ç±»å‹æç¤ºçš„ APIã€‚

#### å…³é”®ç‰¹æ€§

- **é«˜æ€§èƒ½**: åŸºäº Starlette å’Œ Pydanticï¼Œæ€§èƒ½ä¸ NodeJS å’Œ Go ç›¸å½“
- **æ˜“ç”¨æ€§**: è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ï¼ˆSwagger/OpenAPIï¼‰
- **ç±»å‹å®‰å…¨**: åŸºäº Python 3.6+ çš„ç±»å‹æç¤º
- **å¼‚æ­¥æ”¯æŒ**: åŸç”Ÿæ”¯æŒ async/await

#### é¡¹ç›®ä¸­çš„åº”ç”¨

```python
# main.py - FastAPI åº”ç”¨åˆå§‹åŒ–
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI(title=settings.app_name, debug=settings.debug)

# CORS ä¸­é—´ä»¶é…ç½®
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# åŒ…å«è·¯ç”±
app.include_router(api_router, prefix="/api/v1")
```

### 1.2 è·¯ç”±ç³»ç»Ÿ

FastAPI ä½¿ç”¨è£…é¥°å™¨å®šä¹‰è·¯ç”±ï¼Œæ”¯æŒå¼‚æ­¥å’ŒåŒæ­¥å¤„ç†å‡½æ•°ã€‚

#### è·¯ç”±å®šä¹‰ç¤ºä¾‹

```python
# app/api/v1/endpoints/auth.py
from fastapi import APIRouter, Depends, HTTPException

router = APIRouter()

@router.post("/register")
async def register_user(
    user_data: UserRegister,  # Pydantic æ¨¡å‹è‡ªåŠ¨éªŒè¯
    database: Session = Depends(get_database),  # ä¾èµ–æ³¨å…¥
):
    # ä¸šåŠ¡é€»è¾‘
    pass
```

#### ä¾èµ–æ³¨å…¥ç³»ç»Ÿ

FastAPI çš„ä¾èµ–æ³¨å…¥æ˜¯å…¶æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œç”¨äºï¼š
- æ•°æ®åº“ä¼šè¯ç®¡ç†
- ç”¨æˆ·è®¤è¯
- æƒé™æ£€æŸ¥

```python
# æ•°æ®åº“ä¾èµ–
def get_database():
    database = SessionLocal()
    try:
        yield database
    finally:
        database.close()

# è®¤è¯ä¾èµ–
def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    database: Session = Depends(get_database),
) -> User:
    token = credentials.credentials
    token_data = verify_token(token)
    # ... éªŒè¯é€»è¾‘
    return user
```

### 1.3 è¯·æ±‚/å“åº”æ¨¡å‹

ä½¿ç”¨ Pydantic æ¨¡å‹å®šä¹‰è¯·æ±‚å’Œå“åº”çš„æ•°æ®ç»“æ„ï¼Œè‡ªåŠ¨è¿›è¡ŒéªŒè¯å’Œåºåˆ—åŒ–ã€‚

```python
# app/schemas/user.py
from pydantic import BaseModel, EmailStr

class UserRegister(BaseModel):
    username: str
    email: EmailStr
    phone_number: str
    password: str
    sms_code: str

class UserResponse(BaseModel):
    id: int
    username: str
    email: str
    is_active: bool
    
    class Config:
        from_attributes = True  # æ”¯æŒä» ORM æ¨¡å‹è½¬æ¢
```

### 1.4 å¼‚å¸¸å¤„ç†

FastAPI ä½¿ç”¨æ ‡å‡†çš„ HTTPException å¤„ç†é”™è¯¯ã€‚

```python
from fastapi import HTTPException, status

if not user:
    raise HTTPException(
        status_code=status.HTTP_404_NOT_FOUND,
        detail="ç”¨æˆ·ä¸å­˜åœ¨"
    )
```

### 1.5 è‡ªåŠ¨ API æ–‡æ¡£

FastAPI è‡ªåŠ¨ç”Ÿæˆäº¤äº’å¼ API æ–‡æ¡£ï¼š
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

### 1.6 å­¦ä¹ è¦ç‚¹

1. **å¼‚æ­¥ç¼–ç¨‹**: ä½¿ç”¨ `async def` å®šä¹‰å¼‚æ­¥ç«¯ç‚¹ï¼Œä½¿ç”¨ `await` è°ƒç”¨å¼‚æ­¥æ“ä½œ
2. **ç±»å‹æç¤º**: å……åˆ†åˆ©ç”¨ç±»å‹æç¤ºï¼Œæé«˜ä»£ç å¯è¯»æ€§å’Œ IDE æ”¯æŒ
3. **ä¾èµ–æ³¨å…¥**: åˆç†ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œå‡å°‘ä»£ç é‡å¤
4. **Pydantic æ¨¡å‹**: ä½¿ç”¨ Pydantic è¿›è¡Œæ•°æ®éªŒè¯ï¼Œç¡®ä¿æ•°æ®å®‰å…¨

---

## 2. SQLAlchemy ORM ä¸æ•°æ®åº“è®¾è®¡

### 2.1 SQLAlchemy æ ¸å¿ƒæ¦‚å¿µ

SQLAlchemy æ˜¯ Python æœ€æµè¡Œçš„ ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰æ¡†æ¶ï¼Œæä¾›äº† SQL å·¥å…·åŒ…å’Œ ORMã€‚

#### é¡¹ç›®ä¸­çš„æ•°æ®åº“é…ç½®

```python
# app/core/database.py
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.declarative import declarative_base

# åˆ›å»ºæ•°æ®åº“å¼•æ“
engine = create_engine(
    settings.database_url,
    pool_pre_ping=True,      # è¿æ¥å‰æ£€æŸ¥è¿æ¥æ˜¯å¦æœ‰æ•ˆ
    pool_recycle=300,        # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆç§’ï¼‰
)

# åˆ›å»ºä¼šè¯å·¥å‚
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# åŸºç¡€æ¨¡å‹ç±»
Base = declarative_base()
```

### 2.2 æ•°æ®æ¨¡å‹å®šä¹‰

ä½¿ç”¨ SQLAlchemy çš„å£°æ˜å¼è¯­æ³•å®šä¹‰æ•°æ®æ¨¡å‹ã€‚

#### ç”¨æˆ·æ¨¡å‹ç¤ºä¾‹

```python
# app/models/user.py
from sqlalchemy import Column, Integer, String, Boolean, DateTime
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func

class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    uuid = Column(String(36), default=lambda: str(uuid.uuid4()), unique=True)
    username = Column(String, unique=True, index=True, nullable=False)
    email = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String, nullable=False)
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    
    # å…³ç³»å®šä¹‰
    tasks = relationship("Task", back_populates="user")
```

#### å…³é”®æ¦‚å¿µ

1. **è¡¨å®šä¹‰**: `__tablename__` æŒ‡å®šæ•°æ®åº“è¡¨å
2. **åˆ—å®šä¹‰**: ä½¿ç”¨ `Column` å®šä¹‰å­—æ®µï¼ŒæŒ‡å®šç±»å‹ã€çº¦æŸ
3. **ç´¢å¼•**: ä½¿ç”¨ `index=True` åˆ›å»ºç´¢å¼•
4. **å…³ç³»**: ä½¿ç”¨ `relationship` å®šä¹‰è¡¨é—´å…³ç³»
5. **æ—¶é—´æˆ³**: ä½¿ç”¨ `server_default=func.now()` è®¾ç½®é»˜è®¤æ—¶é—´

### 2.3 æ•°æ®åº“ä¼šè¯ç®¡ç†

ä½¿ç”¨ FastAPI çš„ä¾èµ–æ³¨å…¥ç®¡ç†æ•°æ®åº“ä¼šè¯ã€‚

```python
def get_database():
    """è·å–æ•°æ®åº“ä¼šè¯ï¼ˆä¾èµ–æ³¨å…¥ï¼‰"""
    database = SessionLocal()
    try:
        yield database  # ç”Ÿæˆå™¨æ¨¡å¼ï¼Œç¡®ä¿å…³é—­è¿æ¥
    finally:
        database.close()

# åœ¨è·¯ç”±ä¸­ä½¿ç”¨
@router.get("/users/me")
async def get_current_user_info(
    database: Session = Depends(get_database),
):
    # ä½¿ç”¨ database è¿›è¡ŒæŸ¥è¯¢
    pass
```

### 2.4 Alembic æ•°æ®åº“è¿ç§»

Alembic æ˜¯ SQLAlchemy çš„æ•°æ®åº“è¿ç§»å·¥å…·ï¼Œç”¨äºç‰ˆæœ¬æ§åˆ¶æ•°æ®åº“ç»“æ„ã€‚

#### è¿ç§»é…ç½®

```python
# alembic/env.py
from app.core.database import Base
from app.models.user import User
from app.models.task import Task

# å¯¼å…¥æ‰€æœ‰æ¨¡å‹ï¼Œç”¨äºè‡ªåŠ¨ç”Ÿæˆè¿ç§»
target_metadata = Base.metadata
```

#### å¸¸ç”¨è¿ç§»å‘½ä»¤

```bash
# åˆ›å»ºè¿ç§»è„šæœ¬
alembic revision --autogenerate -m "æè¿°ä¿¡æ¯"

# å‡çº§æ•°æ®åº“
alembic upgrade head

# é™çº§æ•°æ®åº“
alembic downgrade -1

# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
alembic current

# æŸ¥çœ‹å†å²
alembic history
```

#### è¿ç§»æ–‡ä»¶ç¤ºä¾‹

```python
# alembic/versions/xxxxx_initial_schema.py
def upgrade():
    op.create_table(
        'users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('username', sa.String(), nullable=False),
        # ...
    )

def downgrade():
    op.drop_table('users')
```

### 2.5 æŸ¥è¯¢æ“ä½œ

#### åŸºæœ¬æŸ¥è¯¢

```python
# æŸ¥è¯¢å•ä¸ª
user = database.query(User).filter(User.id == user_id).first()

# æŸ¥è¯¢å¤šä¸ª
users = database.query(User).filter(User.is_active == True).all()

# æ¡ä»¶æŸ¥è¯¢
user = database.query(User).filter(
    User.username == username,
    User.email == email
).first()

# æ’åºå’Œåˆ†é¡µ
users = database.query(User)\
    .order_by(desc(User.created_at))\
    .offset(skip)\
    .limit(limit)\
    .all()
```

#### å…³è”æŸ¥è¯¢

```python
# é¢„åŠ è½½å…³è”æ•°æ®
user = database.query(User)\
    .options(joinedload(User.tasks))\
    .filter(User.id == user_id)\
    .first()

# è¿æ¥æŸ¥è¯¢
results = database.query(User, Task)\
    .join(Task, User.id == Task.user_id)\
    .filter(Task.status == "completed")\
    .all()
```

### 2.6 äº‹åŠ¡ç®¡ç†

```python
try:
    user = User(username="test", email="test@example.com")
    database.add(user)
    database.commit()
except Exception as e:
    database.rollback()
    raise
```

### 2.7 å­¦ä¹ è¦ç‚¹

1. **æ¨¡å‹è®¾è®¡**: åˆç†è®¾è®¡æ¨¡å‹ç»“æ„ï¼Œè€ƒè™‘æ€§èƒ½å’Œæ‰©å±•æ€§
2. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
3. **å…³ç³»ç®¡ç†**: æ­£ç¡®ä½¿ç”¨ relationshipï¼Œé¿å… N+1 æŸ¥è¯¢
4. **è¿ç§»ç®¡ç†**: ä½¿ç”¨ Alembic ç®¡ç†æ•°æ®åº“ç‰ˆæœ¬ï¼Œä¿æŒä¸€è‡´æ€§
5. **è¿æ¥æ± **: é…ç½®åˆé€‚çš„è¿æ¥æ± å¤§å°å’Œå›æ”¶æ—¶é—´

---

## 3. Redis ç¼“å­˜ä¸è¿æ¥æ± ç®¡ç†

### 3.1 Redis åŸºç¡€

Redis æ˜¯ä¸€ä¸ªå¼€æºçš„å†…å­˜æ•°æ®ç»“æ„å­˜å‚¨ï¼Œç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ã€‚

#### é¡¹ç›®ä¸­çš„ç”¨é€”

1. **ç¼“å­˜**: å­˜å‚¨éªŒè¯ç ã€ä¼šè¯æ•°æ®
2. **ä»¤ç‰Œé»‘åå•**: JWT ä»¤ç‰Œæ’¤é”€
3. **Celery æ¶ˆæ¯é˜Ÿåˆ—**: ä»»åŠ¡æ¶ˆæ¯ä»£ç†å’Œç»“æœåç«¯
4. **è®¡æ•°å™¨**: é™æµã€ç»Ÿè®¡

### 3.2 Redis è¿æ¥æ± ç®¡ç†

é¡¹ç›®å®ç°äº†å®Œæ•´çš„ Redis è¿æ¥æ± ç®¡ç†ï¼Œæ”¯æŒåŠ¨æ€é…ç½®å’Œå¥åº·æ£€æŸ¥ã€‚

#### è¿æ¥æ± å®ç°

```python
# app/core/redis_client.py
class RedisManager:
    """Redisè¿æ¥ç®¡ç†å™¨"""
    
    def __init__(self):
        self._pool = None
        self._client = None
        self._init_connection()
    
    def _init_connection(self):
        """åˆå§‹åŒ–Redisè¿æ¥æ± """
        max_connections = self._get_optimal_connections()
        
        self._pool = redis.ConnectionPool.from_url(
            settings.redis_url,
            max_connections=max_connections,
            retry_on_timeout=True,
            socket_keepalive=True,
            health_check_interval=30,
            socket_connect_timeout=5,
            socket_timeout=10,
        )
        
        self._client = redis.Redis(connection_pool=self._pool)
        self._client.ping()  # æµ‹è¯•è¿æ¥
```

#### è¿æ¥æ± å¤§å°ä¼˜åŒ–

```python
def _get_optimal_connections(self) -> int:
    """æ ¹æ®ç¯å¢ƒè·å–æœ€ä¼˜è¿æ¥æ•°"""
    if settings.debug:
        return 10  # å¼€å‘ç¯å¢ƒ
    else:
        # ç”Ÿäº§ç¯å¢ƒï¼šæ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´
        cpu_count = multiprocessing.cpu_count()
        connections_per_cpu = 8
        optimal_connections = cpu_count * connections_per_cpu
        return min(max(optimal_connections, 20), 100)
```

### 3.3 Redis æ“ä½œ

#### åŸºæœ¬æ“ä½œ

```python
# è®¾ç½®å€¼ï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰
redis_client.setex("key", 300, "value")  # 300ç§’è¿‡æœŸ

# è·å–å€¼
value = redis_client.get("key")

# åˆ é™¤é”®
redis_client.delete("key")

# æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
exists = redis_client.exists("key")

# è®¾ç½®è¿‡æœŸæ—¶é—´
redis_client.expire("key", 300)
```

#### é¡¹ç›®ä¸­çš„åº”ç”¨åœºæ™¯

1. **çŸ­ä¿¡éªŒè¯ç å­˜å‚¨**

```python
# å­˜å‚¨éªŒè¯ç ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
redis_key = f"sms_verification:{mobile}"
redis_client.setex(redis_key, 300, code)

# éªŒè¯éªŒè¯ç 
stored_code = redis_client.get(redis_key)
if stored_code and stored_code.decode("utf-8") == code:
    redis_client.delete(redis_key)  # éªŒè¯ååˆ é™¤
    return True
```

2. **JWT ä»¤ç‰Œé»‘åå•**

```python
# å°†ä»¤ç‰ŒåŠ å…¥é»‘åå•
redis_client.setex(f"blacklist:{token}", expires_in, "1")

# æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•
is_blacklisted = redis_client.exists(f"blacklist:{token}") == 1
```

3. **ç”¨æˆ·ç™»å‡ºæ ‡è®°**

```python
# æ ‡è®°ç”¨æˆ·å·²ç™»å‡ºï¼ˆ7å¤©æœ‰æ•ˆï¼‰
redis_client.setex(f"user_logout:{user_id}", 7*24*60*60, "1")

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å‡º
is_logged_out = redis_client.exists(f"user_logout:{user_id}") == 1
```

### 3.4 è¿æ¥æ± ç›‘æ§

```python
def get_pool_stats(self):
    """è·å–è¿æ¥æ± ç»Ÿè®¡ä¿¡æ¯"""
    return {
        "max_connections": self._pool.max_connections,
        "current_connections": len(self._pool._connections),
        "available_connections": self._pool.max_connections - len(self._pool._connections),
        "connection_usage": f"{len(self._pool._connections)}/{self._pool.max_connections}",
    }
```

### 3.5 æ•…éšœå¤„ç†

é¡¹ç›®å®ç°äº† Mock Redis å®¢æˆ·ç«¯ï¼Œå½“ Redis ä¸å¯ç”¨æ—¶ä»å¯è¿è¡Œï¼ˆåŠŸèƒ½å—é™ï¼‰ã€‚

```python
class _MockRedisClient:
    """æ¨¡æ‹ŸRediså®¢æˆ·ç«¯ï¼Œå½“Redisä¸å¯ç”¨æ—¶ä½¿ç”¨"""
    def setex(self, key, time, value):
        logger.warning(f"æ¨¡æ‹ŸRedisæ“ä½œ: setex {key}")
        return True
```

### 3.6 å­¦ä¹ è¦ç‚¹

1. **è¿æ¥æ± ç®¡ç†**: ä½¿ç”¨è¿æ¥æ± é¿å…é¢‘ç¹åˆ›å»ºè¿æ¥
2. **è¿‡æœŸæ—¶é—´**: åˆç†è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´ï¼Œé¿å…å†…å­˜æ³„æ¼
3. **é”®å‘½åè§„èŒƒ**: ä½¿ç”¨ç»Ÿä¸€çš„å‰ç¼€å’Œå‘½åè§„èŒƒ
4. **æ•…éšœå¤„ç†**: å®ç°é™çº§ç­–ç•¥ï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§
5. **ç›‘æ§**: ç›‘æ§è¿æ¥æ± ä½¿ç”¨æƒ…å†µï¼ŒåŠæ—¶å‘ç°é—®é¢˜

---

## 4. Celery å¼‚æ­¥ä»»åŠ¡å¤„ç†

### 4.1 Celery æ ¸å¿ƒæ¦‚å¿µ

Celery æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨äºå¤„ç†å¼‚æ­¥ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ã€‚

#### æ ¸å¿ƒç»„ä»¶

- **Broker**: æ¶ˆæ¯ä»£ç†ï¼ˆé¡¹ç›®ä¸­ä½¿ç”¨ Redisï¼‰
- **Worker**: å·¥ä½œè¿›ç¨‹ï¼Œæ‰§è¡Œä»»åŠ¡
- **Backend**: ç»“æœåç«¯ï¼Œå­˜å‚¨ä»»åŠ¡ç»“æœï¼ˆé¡¹ç›®ä¸­ä½¿ç”¨ Redisï¼‰

### 4.2 Celery é…ç½®

```python
# app/core/celery_app.py
from celery import Celery

celery_app = Celery(
    "data_station_api",
    broker=settings.celery_broker_url,
    backend=settings.celery_result_backend,
)

celery_app.conf.update(
    task_serializer="json",
    accept_content=["json"],
    result_serializer="json",
    timezone="UTC",
    enable_utc=True,
    task_track_started=True,
    task_time_limit=30 * 60,  # 30åˆ†é’Ÿè¶…æ—¶
    broker_connection_retry_on_startup=True,
    result_expires=3600,  # ç»“æœè¿‡æœŸæ—¶é—´1å°æ—¶
    worker_prefetch_multiplier=1,
    task_acks_late=True,
)
```

### 4.3 ä»»åŠ¡å®šä¹‰

ä½¿ç”¨è£…é¥°å™¨å®šä¹‰ Celery ä»»åŠ¡ã€‚

```python
# ç®€å•ä»»åŠ¡
@celery_app.task(name="health_check_task")
def health_check_task():
    return {"status": "healthy"}

# å¤æ‚ä»»åŠ¡ï¼ˆæ”¯æŒçŠ¶æ€æ›´æ–°ï¼‰
@celery_app.task(
    name="fetch_data_task",
    bind=True,  # ç»‘å®šä»»åŠ¡å®ä¾‹ï¼Œå¯è®¿é—® self
    max_retries=3,
    default_retry_delay=60,
    autoretry_for=(Exception,),
)
def fetch_data_task(self, task_params: dict):
    task_id = self.request.id
    
    # æ›´æ–°ä»»åŠ¡çŠ¶æ€
    self.update_state(
        state="PROCESSING",
        meta={"progress": 0, "message": "å¼€å§‹å¤„ç†"}
    )
    
    try:
        # ä»»åŠ¡é€»è¾‘
        for i in range(10):
            progress = int(((i + 1) / 10) * 100)
            self.update_state(
                state="PROCESSING",
                meta={"progress": progress, "message": f"å¤„ç†æ­¥éª¤ {i+1}"}
            )
            time.sleep(1)
        
        result = {"status": "success", "data": "..."}
        self.update_state(
            state="SUCCESS",
            meta={"progress": 100, "result": result}
        )
        return result
    except Exception as e:
        self.update_state(
            state="FAILURE",
            meta={"error": str(e)}
        )
        raise
```

### 4.4 ä»»åŠ¡æäº¤å’ŒæŸ¥è¯¢

#### æäº¤ä»»åŠ¡

```python
# åœ¨ API ç«¯ç‚¹ä¸­æäº¤ä»»åŠ¡
from app.core.celery_app import celery_app

task = celery_app.send_task(
    "fetch_data_task",
    args=[task_params],
    countdown=10  # å»¶è¿Ÿ10ç§’æ‰§è¡Œ
)

task_id = task.id
```

#### æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

```python
# æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
from celery.result import AsyncResult

result = AsyncResult(task_id, app=celery_app)

if result.ready():
    if result.successful():
        data = result.get()
    else:
        error = result.info
else:
    # ä»»åŠ¡è¿˜åœ¨è¿è¡Œï¼Œè·å–å½“å‰çŠ¶æ€
    state = result.state
    meta = result.info
```

### 4.5 ä»»åŠ¡çŠ¶æ€ç®¡ç†

é¡¹ç›®åœ¨æ•°æ®åº“ä¸­å­˜å‚¨ä»»åŠ¡çŠ¶æ€ï¼Œä¸ Celery çŠ¶æ€åŒæ­¥ã€‚

```python
# app/models/task.py
class TaskStatus:
    PENDING = "pending"
    QUEUED = "queued"
    PROCESSING = "processing"
    COMPLETED = "completed"
    FAILED = "failed"
    CANCELLED = "cancelled"
    EXPIRED = "expired"

class Task(Base):
    uuid = Column(String(36), unique=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    status = Column(String, default=TaskStatus.PENDING)
    progress = Column(Integer, default=0)
    result = Column(JSON)
    error_message = Column(String)
```

### 4.6 Worker å¯åŠ¨

```python
# celery_worker.py
from app.core.celery_app import celery_app

celery_app.worker_main([
    "worker",
    "--loglevel=info",
    "--concurrency=2",
    "--queues=default",
])
```

å¯åŠ¨å‘½ä»¤ï¼š
```bash
python celery_worker.py
# æˆ–
celery -A app.core.celery_app worker --loglevel=info
```

### 4.7 ä»»åŠ¡å–æ¶ˆ

```python
# å–æ¶ˆä»»åŠ¡
celery_app.control.revoke(task_id, terminate=True)

# åœ¨æ•°æ®åº“ä¸­æ›´æ–°çŠ¶æ€
TaskService.update_task_status(
    database, task_id, TaskStatus.CANCELLED
)
```

### 4.8 å­¦ä¹ è¦ç‚¹

1. **ä»»åŠ¡è®¾è®¡**: ä»»åŠ¡åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼Œæ”¯æŒé‡è¯•
2. **çŠ¶æ€æ›´æ–°**: åŠæ—¶æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼Œæ–¹ä¾¿ç”¨æˆ·æŸ¥è¯¢è¿›åº¦
3. **é”™è¯¯å¤„ç†**: å®ç°å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
4. **èµ„æºç®¡ç†**: æ³¨æ„ Worker çš„èµ„æºä½¿ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼
5. **ç›‘æ§**: ç›‘æ§ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼ŒåŠæ—¶å‘ç°é—®é¢˜

---

## 5. JWT è®¤è¯ä¸å®‰å…¨æœºåˆ¶

### 5.1 JWT åŸºç¡€

JWT (JSON Web Token) æ˜¯ä¸€ç§å¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œç”¨äºå®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ã€‚

#### JWT ç»“æ„

JWT ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š
- **Header**: ç®—æ³•å’Œä»¤ç‰Œç±»å‹
- **Payload**: æ•°æ®ï¼ˆç”¨æˆ·ä¿¡æ¯ã€è¿‡æœŸæ—¶é—´ç­‰ï¼‰
- **Signature**: ç­¾åï¼Œç”¨äºéªŒè¯ä»¤ç‰Œ

#### é¡¹ç›®ä¸­çš„ JWT é…ç½®

```python
# app/core/config.py
SECRET_KEY = os.getenv("SECRET_KEY")
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30
REFRESH_TOKEN_EXPIRE_DAYS = 7
```

### 5.2 ä»¤ç‰Œç”Ÿæˆ

```python
# app/core/security.py
import jwt
from datetime import datetime, timedelta, timezone

def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str:
    """åˆ›å»ºè®¿é—®ä»¤ç‰Œ"""
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.now(timezone.utc) + expires_delta
    else:
        expire = datetime.now(timezone.utc) + timedelta(
            minutes=settings.access_token_expire_minutes
        )
    
    to_encode.update({
        "exp": expire,
        "type": "access"  # ä»¤ç‰Œç±»å‹
    })
    
    encoded_jwt = jwt.encode(
        to_encode,
        settings.secret_key,
        algorithm=settings.algorithm
    )
    return encoded_jwt

def create_refresh_token(data: dict) -> str:
    """åˆ›å»ºåˆ·æ–°ä»¤ç‰Œ"""
    to_encode = data.copy()
    expire = datetime.now(timezone.utc) + timedelta(
        days=settings.refresh_token_expire_days
    )
    
    to_encode.update({
        "exp": expire,
        "type": "refresh"
    })
    
    return jwt.encode(to_encode, settings.secret_key, algorithm=settings.algorithm)
```

### 5.3 ä»¤ç‰ŒéªŒè¯

```python
def verify_token(token: str) -> TokenData:
    """éªŒè¯ä»¤ç‰Œ"""
    try:
        # æ£€æŸ¥é»‘åå•
        if is_token_blacklisted(token):
            raise HTTPException(
                status_code=401,
                detail="ä»¤ç‰Œå·²è¢«æ³¨é”€"
            )
        
        # è§£ç ä»¤ç‰Œ
        payload = jwt.decode(
            token,
            settings.secret_key,
            algorithms=[settings.algorithm]
        )
        
        username = payload.get("sub")
        user_id = payload.get("user_id")
        token_type = payload.get("type")
        
        if not all([username, user_id, token_type]):
            raise HTTPException(status_code=401, detail="æ— æ•ˆçš„ä»¤ç‰Œ")
        
        return TokenData(username=username, user_id=user_id)
    
    except jwt.ExpiredSignatureError:
        raise HTTPException(status_code=401, detail="ä»¤ç‰Œå·²è¿‡æœŸ")
    except jwt.InvalidTokenError:
        raise HTTPException(status_code=401, detail="æ— æ•ˆçš„ä»¤ç‰Œ")
```

### 5.4 ä»¤ç‰Œé»‘åå•æœºåˆ¶

é¡¹ç›®å®ç°äº†ä»¤ç‰Œé»‘åå•ï¼Œç”¨äºç™»å‡ºæ—¶æ’¤é”€ä»¤ç‰Œã€‚

```python
def add_token_to_blacklist(token: str, expires_in: int = 1800) -> bool:
    """å°†ä»¤ç‰Œæ·»åŠ åˆ°é»‘åå•"""
    redis_client.setex(f"blacklist:{token}", expires_in, "1")
    return True

def is_token_blacklisted(token: str) -> bool:
    """æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­"""
    return redis_client.exists(f"blacklist:{token}") == 1
```

### 5.5 ç”¨æˆ·è®¤è¯ä¾èµ–

ä½¿ç”¨ FastAPI çš„ä¾èµ–æ³¨å…¥å®ç°è®¤è¯ã€‚

```python
def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    database: Session = Depends(get_database),
) -> User:
    """è·å–å½“å‰ç”¨æˆ·"""
    token = credentials.credentials
    token_data = verify_token(token)
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å‡º
    if is_user_logged_out(token_data.user_id):
        raise HTTPException(status_code=401, detail="ç”¨æˆ·å·²ç™»å‡º")
    
    user = database.query(User).filter(User.id == token_data.user_id).first()
    if not user or not user.is_active:
        raise HTTPException(status_code=401, detail="ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨")
    
    return user

def get_current_admin_user(
    current_user: User = Depends(get_current_active_user),
) -> User:
    """è·å–å½“å‰ç®¡ç†å‘˜ç”¨æˆ·"""
    if current_user.role not in [UserRole.ADMIN, UserRole.SUPER_ADMIN]:
        raise HTTPException(status_code=403, detail="éœ€è¦ç®¡ç†å‘˜æƒé™")
    return current_user
```

### 5.6 å¯†ç åŠ å¯†

ä½¿ç”¨ bcrypt è¿›è¡Œå¯†ç å“ˆå¸Œã€‚

```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def get_password_hash(password: str) -> str:
    """è·å–å¯†ç å“ˆå¸Œ"""
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """éªŒè¯å¯†ç """
    return pwd_context.verify(plain_password, hashed_password)
```

### 5.7 ç™»å½•æµç¨‹

```python
@router.post("/login")
async def login(
    user_data: UserLogin,
    database: Session = Depends(get_database),
):
    # éªŒè¯ç”¨æˆ·
    user = authenticate_user(database, user_data.account, user_data.password)
    if not user:
        raise HTTPException(status_code=401, detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
    
    # åˆ›å»ºä»¤ç‰Œ
    tokens = create_tokens(user)
    
    return tokens
```

### 5.8 åˆ·æ–°ä»¤ç‰Œæµç¨‹

```python
@router.post("/refresh")
async def refresh_token(
    token_data: TokenRefresh,
    database: Session = Depends(get_database),
):
    # éªŒè¯åˆ·æ–°ä»¤ç‰Œ
    token_data_obj = verify_token(token_data.refresh_token)
    
    # æ£€æŸ¥ä»¤ç‰Œç±»å‹
    payload = jwt.decode(
        token_data.refresh_token,
        settings.secret_key,
        algorithms=[settings.algorithm]
    )
    if payload.get("type") != "refresh":
        raise HTTPException(status_code=401, detail="éœ€è¦åˆ·æ–°ä»¤ç‰Œ")
    
    # è·å–ç”¨æˆ·
    user = database.query(User).filter(User.id == token_data_obj.user_id).first()
    
    # ç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œ
    new_tokens = create_access_token_only(user)
    return new_tokens
```

### 5.9 ç™»å‡ºæµç¨‹

```python
@router.post("/logout")
async def logout(
    current_user: User = Depends(get_current_user),
    credentials: HTTPAuthorizationCredentials = Depends(security),
):
    token = credentials.credentials
    
    # å°†å½“å‰ä»¤ç‰ŒåŠ å…¥é»‘åå•
    logout_user(token)
    
    # æ’¤é”€ç”¨æˆ·æ‰€æœ‰ä»¤ç‰Œï¼ˆå¯é€‰ï¼‰
    logout_user_all_tokens(current_user.id)
    
    return {"message": "ç™»å‡ºæˆåŠŸ"}
```

### 5.10 å­¦ä¹ è¦ç‚¹

1. **å¯†é’¥ç®¡ç†**: ä½¿ç”¨å¼ºå¯†é’¥ï¼Œä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç 
2. **ä»¤ç‰Œè¿‡æœŸ**: è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œå¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ
3. **ä»¤ç‰Œæ’¤é”€**: å®ç°ä»¤ç‰Œé»‘åå•æˆ–ç”¨æˆ·çº§åˆ«æ’¤é”€
4. **å¯†ç å®‰å…¨**: ä½¿ç”¨ bcrypt ç­‰å®‰å…¨å“ˆå¸Œç®—æ³•
5. **HTTPS**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS ä¼ è¾“ä»¤ç‰Œ

---

## 6. é¡¹ç›®æ¶æ„è®¾è®¡æ¨¡å¼

### 6.1 åˆ†å±‚æ¶æ„

é¡¹ç›®é‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API å±‚ (endpoints/)           â”‚  â† å¤„ç† HTTP è¯·æ±‚/å“åº”
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æœåŠ¡å±‚ (services/)            â”‚  â† ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®è®¿é—®å±‚ (models/)          â”‚  â† æ•°æ®åº“æ“ä½œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 API å±‚ï¼ˆendpoints/ï¼‰

è´Ÿè´£å¤„ç† HTTP è¯·æ±‚ï¼Œè°ƒç”¨æœåŠ¡å±‚ã€‚

```python
# app/api/v1/endpoints/users.py
@router.get("/me")
async def get_current_user_info(
    current_user: User = Depends(get_current_active_user),
):
    return {
        "id": current_user.id,
        "username": current_user.username,
        "email": current_user.email,
    }
```

### 6.3 æœåŠ¡å±‚ï¼ˆservices/ï¼‰

åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œå¯è¢«å¤šä¸ªç«¯ç‚¹å¤ç”¨ã€‚

```python
# app/services/user_service.py
class UserService:
    @staticmethod
    def get_user_by_username(database: Session, username: str) -> Optional[User]:
        return database.query(User).filter(User.username == username).first()
    
    @staticmethod
    def create_user(database: Session, user_data: dict) -> User:
        user = User(**user_data)
        database.add(user)
        database.commit()
        database.refresh(user)
        return user
```

### 6.4 æ•°æ®æ¨¡å‹å±‚ï¼ˆmodels/ï¼‰

å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„ã€‚

```python
# app/models/user.py
class User(Base):
    __tablename__ = "users"
    # ... å­—æ®µå®šä¹‰
```

### 6.5 æ•°æ®éªŒè¯å±‚ï¼ˆschemas/ï¼‰

ä½¿ç”¨ Pydantic å®šä¹‰è¯·æ±‚/å“åº”æ•°æ®ç»“æ„ã€‚

```python
# app/schemas/user.py
class UserRegister(BaseModel):
    username: str
    email: EmailStr
    password: str
```

### 6.6 ä¾èµ–æ³¨å…¥æ¨¡å¼

å¤§é‡ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œæé«˜ä»£ç å¯æµ‹è¯•æ€§ã€‚

```python
# æ•°æ®åº“ä¾èµ–
def get_database():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# è®¤è¯ä¾èµ–
def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    database: Session = Depends(get_database),
) -> User:
    # ...
```

### 6.7 é…ç½®ç®¡ç†

é›†ä¸­ç®¡ç†é…ç½®ï¼Œä»ç¯å¢ƒå˜é‡è¯»å–ã€‚

```python
# app/core/config.py
class Settings:
    database_url: str = os.getenv("DATABASE_URL")
    secret_key: str = os.getenv("SECRET_KEY")
    # ...

settings = Settings()
```

### 6.8 é”™è¯¯å¤„ç†

ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ã€‚

```python
from fastapi import HTTPException, status

try:
    # ä¸šåŠ¡é€»è¾‘
except ValueError as e:
    raise HTTPException(
        status_code=status.HTTP_400_BAD_REQUEST,
        detail=str(e)
    )
```

### 6.9 æ—¥å¿—ç³»ç»Ÿ

ä½¿ç”¨ loguru è¿›è¡Œæ—¥å¿—è®°å½•ã€‚

```python
from loguru import logger

logger.info("ç”¨æˆ·ç™»å½•æˆåŠŸ")
logger.error(f"é”™è¯¯ä¿¡æ¯: {str(e)}")
logger.debug(f"è°ƒè¯•ä¿¡æ¯: {data}")
```

### 6.10 å­¦ä¹ è¦ç‚¹

1. **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
2. **ä¾èµ–æ³¨å…¥**: ä½¿ç”¨ä¾èµ–æ³¨å…¥æé«˜å¯æµ‹è¯•æ€§
3. **åˆ†å±‚æ¸…æ™°**: ä¿æŒå±‚æ¬¡æ¸…æ™°ï¼Œé¿å…è·¨å±‚è°ƒç”¨
4. **é…ç½®é›†ä¸­**: é›†ä¸­ç®¡ç†é…ç½®ï¼Œä¾¿äºç»´æŠ¤
5. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼Œæä¾›å‹å¥½é”™è¯¯ä¿¡æ¯

---

## 7. äº‘æœåŠ¡é›†æˆ

### 7.1 é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡

ç”¨äºå‘é€çŸ­ä¿¡éªŒè¯ç ã€‚

```python
# app/core/sms.py
from alibabacloud_dysmsapi20170525.client import Client as DysmsapiClient

def send_message_code(mobile: str) -> bool:
    """å‘é€çŸ­ä¿¡éªŒè¯ç """
    # åˆå§‹åŒ–å®¢æˆ·ç«¯
    config = open_api_models.Config(
        access_key_id=settings.ali_access_key_id,
        access_key_secret=settings.ali_access_key_secret,
    )
    client = DysmsapiClient(config)
    
    # ç”ŸæˆéªŒè¯ç 
    code = str(random.randint(100000, 999999))
    
    # å‘é€çŸ­ä¿¡
    request = dysmsapi_20170525_models.SendSmsRequest(
        phone_numbers=mobile,
        template_code=settings.aliyun_sms_template_code,
        template_param=json.dumps({"code": code}),
        sign_name=settings.aliyun_sms_sign_name,
    )
    
    response = client.send_sms_with_options(request, runtime)
    
    # å­˜å‚¨éªŒè¯ç åˆ° Redisï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
    redis_client.setex(f"sms_verification:{mobile}", 300, code)
    
    return True
```

### 7.2 é˜¿é‡Œäº‘é‚®ä»¶æœåŠ¡

ç”¨äºå‘é€éªŒè¯é‚®ä»¶ã€‚

```python
# app/core/alimail.py
from alibabacloud_dm20151123.client import Client as DmClient

def send_verification_email(email: str, verification_link: str):
    """å‘é€éªŒè¯é‚®ä»¶"""
    # åˆå§‹åŒ–å®¢æˆ·ç«¯
    config = open_api_models.Config(
        access_key_id=settings.ali_access_key_id,
        access_key_secret=settings.ali_access_key_secret,
    )
    client = DmClient(config)
    
    # æ„å»ºé‚®ä»¶å†…å®¹
    request = dm_20151123_models.SingleSendMailRequest(
        account_name=settings.ali_mail_account_name,
        to_address=email,
        subject="é‚®ç®±éªŒè¯",
        html_body=render_template("verification.html", link=verification_link),
    )
    
    client.single_send_mail_with_options(request, runtime)
```

### 7.3 è…¾è®¯äº‘éªŒè¯ç 

ç”¨äºéªŒè¯ç”¨æˆ·æäº¤çš„éªŒè¯ç ã€‚

```python
# app/core/tencent_captcha.py
from tencentcloud.common.credential import Credential
from tencentcloud.captcha.v20190722 import captcha_client, models

def verify_tencent_captcha(ticket: str, randstr: str, user_ip: str) -> bool:
    """éªŒè¯è…¾è®¯éªŒè¯ç """
    cred = Credential(
        settings.tencent_secret_id,
        settings.tencent_secret_key
    )
    
    client = captcha_client.CaptchaClient(cred, "ap-shanghai")
    
    req = models.DescribeCaptchaResultRequest()
    req.CaptchaType = 9
    req.Ticket = ticket
    req.UserIp = user_ip
    req.CaptchaAppId = int(settings.tencent_captcha_appid)
    req.AppSecretKey = settings.tencent_app_secretkey
    
    resp = client.DescribeCaptchaResult(req)
    
    return resp.CaptchaCode == 1
```

### 7.4 å­¦ä¹ è¦ç‚¹

1. **å¯†é’¥ç®¡ç†**: ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥ï¼Œä¸è¦ç¡¬ç¼–ç 
2. **é”™è¯¯å¤„ç†**: å¤„ç†æœåŠ¡è°ƒç”¨å¤±è´¥çš„æƒ…å†µ
3. **é™æµ**: å®ç°å‘é€é¢‘ç‡é™åˆ¶ï¼Œé˜²æ­¢æ»¥ç”¨
4. **æˆæœ¬æ§åˆ¶**: ç›‘æ§æœåŠ¡ä½¿ç”¨é‡ï¼Œæ§åˆ¶æˆæœ¬
5. **é™çº§ç­–ç•¥**: æœåŠ¡ä¸å¯ç”¨æ—¶æä¾›é™çº§æ–¹æ¡ˆ

---

## 8. æµ‹è¯•ä¸éƒ¨ç½²

### 8.1 æµ‹è¯•æ¡†æ¶

ä½¿ç”¨ pytest è¿›è¡Œæµ‹è¯•ã€‚

```python
# tests/conftest.py
import pytest
from fastapi.testclient import TestClient
from app.core.database import SessionLocal

@pytest.fixture
def client():
    from main import app
    return TestClient(app)

@pytest.fixture
def database():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### 8.2 å•å…ƒæµ‹è¯•ç¤ºä¾‹

```python
# tests/api/v1/endpoints/test_auth.py
def test_register_user(client):
    response = client.post(
        "/api/v1/auth/register",
        json={
            "username": "testuser",
            "email": "test@example.com",
            "password": "password123",
            "sms_code": "123456",
        }
    )
    assert response.status_code == 200
    assert "access_token" in response.json()
```

### 8.3 Docker éƒ¨ç½²

```dockerfile
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 8.4 ç¯å¢ƒé…ç½®

ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†é…ç½®ã€‚

```bash
# .env æ–‡ä»¶
DATABASE_URL=postgresql://user:pass@localhost/db
SECRET_KEY=your-secret-key
REDIS_URL=redis://localhost:6379/0
```

### 8.5 éƒ¨ç½²æµç¨‹

1. **æ„å»ºé•œåƒ**
   ```bash
   docker build -t web-api .
   ```

2. **è¿è¡Œå®¹å™¨**
   ```bash
   docker run -d \
     -p 8000:8000 \
     --env-file .env \
     web-api
   ```

3. **æ•°æ®åº“è¿ç§»**
   ```bash
   docker exec -it container_name alembic upgrade head
   ```

### 8.6 å­¦ä¹ è¦ç‚¹

1. **æµ‹è¯•è¦†ç›–**: ç¼–å†™å……åˆ†çš„æµ‹è¯•ï¼Œè¦†ç›–ä¸»è¦åŠŸèƒ½
2. **CI/CD**: é…ç½®è‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²æµç¨‹
3. **ç›‘æ§**: éƒ¨ç½²ç›‘æ§ç³»ç»Ÿï¼ŒåŠæ—¶å‘ç°é—®é¢˜
4. **æ—¥å¿—**: é…ç½®æ—¥å¿—æ”¶é›†å’Œåˆ†æ
5. **å¤‡ä»½**: å®šæœŸå¤‡ä»½æ•°æ®åº“å’Œé‡è¦æ•°æ®

---

## 9. æœ€ä½³å®è·µæ€»ç»“

### 9.1 ä»£ç ç»„ç»‡

- âœ… ä½¿ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„
- âœ… ä¿æŒæ¨¡å—èŒè´£å•ä¸€
- âœ… ä½¿ç”¨ç±»å‹æç¤ºæé«˜ä»£ç å¯è¯»æ€§
- âœ… ç¼–å†™æ¸…æ™°çš„æ–‡æ¡£å­—ç¬¦ä¸²

### 9.2 å®‰å…¨å®è·µ

- âœ… ä½¿ç”¨ HTTPS ä¼ è¾“æ•æ„Ÿæ•°æ®
- âœ… å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†
- âœ… å®ç°ä»¤ç‰Œé»‘åå•æœºåˆ¶
- âœ… éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥
- âœ… è®¾ç½®åˆç†çš„ä»¤ç‰Œè¿‡æœŸæ—¶é—´

### 9.3 æ€§èƒ½ä¼˜åŒ–

- âœ… ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± 
- âœ… ä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
- âœ… å¼‚æ­¥å¤„ç†è€—æ—¶ä»»åŠ¡
- âœ… åˆç†ä½¿ç”¨æ•°æ®åº“ç´¢å¼•

### 9.4 é”™è¯¯å¤„ç†

- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- âœ… å®ç°æ•…éšœé™çº§ç­–ç•¥

### 9.5 å¯ç»´æŠ¤æ€§

- âœ… ä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†è®¾ç½®
- âœ… ä½¿ç”¨ä¾èµ–æ³¨å…¥æé«˜å¯æµ‹è¯•æ€§
- âœ… ç¼–å†™æ¸…æ™°çš„æ³¨é‡Šå’Œæ–‡æ¡£
- âœ… éµå¾ªä»£ç è§„èŒƒï¼ˆflake8ï¼‰

---

## ğŸ“– å­¦ä¹ èµ„æºæ¨è

### å®˜æ–¹æ–‡æ¡£

- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [SQLAlchemy æ–‡æ¡£](https://docs.sqlalchemy.org/)
- [Celery æ–‡æ¡£](https://docs.celeryproject.org/)
- [Redis æ–‡æ¡£](https://redis.io/documentation)
- [Alembic æ–‡æ¡£](https://alembic.sqlalchemy.org/)

### ç›¸å…³æŠ€æœ¯

- [Pydantic æ–‡æ¡£](https://docs.pydantic.dev/)
- [JWT å®˜æ–¹æ–‡æ¡£](https://jwt.io/)
- [Docker æ–‡æ¡£](https://docs.docker.com/)
- [pytest æ–‡æ¡£](https://docs.pytest.org/)

---

## ğŸ”§ å®è·µç»ƒä¹ 

### ç»ƒä¹  1: åˆ›å»ºæ–°çš„ API ç«¯ç‚¹

åˆ›å»ºä¸€ä¸ªæ–°çš„ç«¯ç‚¹ï¼Œå®ç°ç”¨æˆ·èµ„æ–™æ›´æ–°åŠŸèƒ½ã€‚

### ç»ƒä¹  2: å®ç°ç¼“å­˜æœºåˆ¶

ä¸ºçƒ­ç‚¹æ•°æ®æ·»åŠ  Redis ç¼“å­˜ã€‚

### ç»ƒä¹  3: æ·»åŠ æ–°çš„ Celery ä»»åŠ¡

åˆ›å»ºä¸€ä¸ªæ–°çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½ã€‚

### ç»ƒä¹  4: ç¼–å†™å•å…ƒæµ‹è¯•

ä¸ºå…³é”®åŠŸèƒ½ç¼–å†™å•å…ƒæµ‹è¯•ã€‚

---

## ğŸ“ æ€»ç»“

è¿™ä»½å­¦ä¹ ç¬”è®°æ¶µç›–äº† Data Station Web API é¡¹ç›®ä¸­ä½¿ç”¨çš„æ ¸å¿ƒæŠ€æœ¯ï¼š

1. **FastAPI**: ç°ä»£åŒ–çš„å¼‚æ­¥ Web æ¡†æ¶
2. **SQLAlchemy**: å¼ºå¤§çš„ ORM æ¡†æ¶
3. **Redis**: é«˜æ€§èƒ½ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ—
4. **Celery**: åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—
5. **JWT**: å®‰å…¨çš„è®¤è¯æœºåˆ¶
6. **äº‘æœåŠ¡**: çŸ­ä¿¡ã€é‚®ä»¶ã€éªŒè¯ç é›†æˆ

é€šè¿‡å­¦ä¹ å’Œå®è·µè¿™äº›æŠ€æœ¯ï¼Œä½ å°†èƒ½å¤Ÿæ„å»ºä¼ä¸šçº§çš„ Web API åº”ç”¨ã€‚

---

**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ä½œè€…**: åŸºäº Data Station Web API é¡¹ç›®æ•´ç†

